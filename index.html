<!doctype html>
<html lang="ar" dir="rtl">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Ù„Ø¹Ø¨Ø© Ù…Ø±Ø§Ø¨Ø·</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&amp;display=swap" rel="stylesheet">
  <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        /* Ø§Ù„Ø¬Ø³Ù… ÙŠØ¨Ù‚Ù‰ Ø·Ø¨ÙŠØ¹ÙŠ Ø­ØªÙ‰ Ù„Ø§ ØªØªØºÙŠØ± Ø§Ù„Ø£Ù„ÙˆØ§Ù† */
body {
    font-family: 'Tajawal', sans-serif;
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
    min-height: 100vh;
    color: #fff;
    margin: 0;
    padding: 0;
    overflow-x: hidden;
}

/* Ø­Ø§ÙˆÙŠØ© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù‡ÙŠ Ø§Ù„ØªÙŠ ØªØªØ­ÙƒÙ… Ø¨Ø§Ù„ØªÙ…Ø±ÙŠØ± */
#app {
    height: 100vh;
    width: 100vw;
    overflow: hidden;
    position: fixed;
    inset: 0;
    touch-action: none;
}

        
        /* Main Screen */
        .main-screen {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    
    /* Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: ØªØ­ÙˆÙŠÙ„ min-height Ø¥Ù„Ù‰ height Ø«Ø§Ø¨ØªØ© */
    height: 100vh; 
    max-height: 100vh;
    width: 100%;
    
    overflow: hidden; /* Ù…Ù†Ø¹ Ø£ÙŠ Ø¹Ù†ØµØ± Ø¯Ø§Ø®Ù„ÙŠ Ù…Ù† Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªÙ…Ø±ÙŠØ± */
    padding: 20px;
}
        
        .logo {
            font-size: 4rem;
            font-weight: 800;
            background: linear-gradient(45deg, #e94560, #0f3460, #e94560);
            background-size: 200% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: gradientShift 3s ease infinite;
            margin-bottom: 10px;
            text-shadow: 0 0 30px rgba(233, 69, 96, 0.3);
        }
        
        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        
        .subtitle {
            color: #a0a0a0;
            margin-bottom: 40px;
            font-size: 1.1rem;
        }
        
        .input-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 100%;
            max-width: 320px;
        }
        
        .input-field {
            padding: 16px 20px;
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            background: rgba(255,255,255,0.05);
            color: #fff;
            font-size: 1.1rem;
            font-family: 'Tajawal', sans-serif;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .input-field:focus {
            outline: none;
            border-color: #e94560;
            background: rgba(233, 69, 96, 0.1);
            box-shadow: 0 0 20px rgba(233, 69, 96, 0.2);
        }
        
        .input-field::placeholder {
            color: #666;
        }
        
        .btn {
            padding: 16px 32px;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 700;
            font-family: 'Tajawal', sans-serif;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #e94560, #c73e54);
            color: #fff;
            box-shadow: 0 4px 15px rgba(233, 69, 96, 0.4);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(233, 69, 96, 0.5);
        }
        
        .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: #fff;
            border: 2px solid rgba(255,255,255,0.2);
        }
        
        .btn-secondary:hover {
            background: rgba(255,255,255,0.15);
            border-color: rgba(255,255,255,0.3);
        }
        
        /* Game Screen */
        .game-screen {
    display: none; /* ÙŠØªÙ… ØªØºÙŠÙŠØ±Ù‡ Ø¹Ø¨Ø± Ø§Ù„Ø¬Ø§ÙØ§ Ø³ÙƒØ±Ø¨Øª Ø¥Ù„Ù‰ flex */
    flex-direction: column;
    
    /* Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø«Ø§Ø¨Øª */
    height: 100vh; 
    max-height: 100vh;
    width: 100%;
    
    overflow: hidden; /* Ù‡Ø°Ø§ ÙŠØ¶Ù…Ù† Ø¨Ù‚Ø§Ø¡ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¯Ø§Ø®Ù„ Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø´Ø§Ø´Ø© */
}
        
        /* Top Bar */
        .top-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            background: rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            flex-shrink: 0;
            gap: 8px;
        }
        
        .top-bar-section {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .top-btn {
            padding: 6px 10px;
            border: none;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 600;
            font-family: 'Tajawal', sans-serif;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
        }
        
        .top-btn-icon {
            background: rgba(255,255,255,0.1);
            color: #fff;
        }
        
        .top-btn-icon:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .players-count {
            background: rgba(233, 69, 96, 0.2);
            color: #e94560;
            padding: 6px 10px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
        }
        
        /* Turn Indicator */
        .turn-indicator {
            text-align: center;
            padding: 6px;
            background: rgba(0,0,0,0.2);
            font-weight: 700;
            font-size: 0.9rem;
            flex-shrink: 0;
        }
        
        .turn-red { background: linear-gradient(90deg, transparent, rgba(239, 68, 68, 0.3), transparent); color: #fca5a5; }
        .turn-blue { background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.3), transparent); color: #93c5fd; }
        
        /* Main Game Area */
        .game-content {
            display: flex;
            flex: 1;
            overflow: hidden;
            min-height: 0;
        }
        
        /* Team Panels */
        .team-panel {
            width: 110px;
            display: flex;
            flex-direction: column;
            padding: 6px;
            flex-shrink: 0;
            overflow-y: auto;
        }
        
        .team-panel.red { background: linear-gradient(180deg, rgba(239, 68, 68, 0.15), rgba(239, 68, 68, 0.05)); }
        .team-panel.blue { background: linear-gradient(180deg, rgba(59, 130, 246, 0.15), rgba(59, 130, 246, 0.05)); }
        
        .team-header {
            text-align: center;
            padding: 6px;
            border-radius: 8px;
            margin-bottom: 6px;
            font-weight: 700;
            font-size: 0.85rem;
        }
        
        .team-header.red { background: rgba(239, 68, 68, 0.3); color: #fca5a5; }
        .team-header.blue { background: rgba(59, 130, 246, 0.3); color: #93c5fd; }
        
        .team-score {
            font-size: 1.5rem;
            font-weight: 800;
        }
        
        .team-section {
            margin-bottom: 8px;
        }
        
        .section-title {
            font-size: 0.7rem;
            color: #888;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .player-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 4px 6px;
            background: rgba(255,255,255,0.05);
            border-radius: 6px;
            margin-bottom: 3px;
            font-size: 0.75rem;
            transition: all 0.2s ease;
        }
        
        .player-item.offline {
            opacity: 0.4;
        }
        
        .player-item.red { border-right: 2px solid #ef4444; }
        .player-item.blue { border-right: 2px solid #3b82f6; }
        
        .join-team-btn {
            width: 100%;
            padding: 6px;
            border: 2px dashed rgba(255,255,255,0.2);
            border-radius: 6px;
            background: transparent;
            color: #888;
            font-size: 0.7rem;
            font-family: 'Tajawal', sans-serif;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-top: 4px;
        }
        
        .join-team-btn:hover {
            border-color: rgba(255,255,255,0.4);
            color: #fff;
        }
        
        /* Center Area */
        .center-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 6px;
            min-width: 0;
            overflow: hidden;
            gap: 6px;
        }
        
        /* Start Game Button */
        .start-game-container {
            display: flex;
            align-items: center;
            justify-content: center;
            flex: 1;
        }
        
        .start-game-btn {
            padding: 20px 40px;
            background: linear-gradient(135deg, #22c55e, #16a34a);
            border: none;
            border-radius: 16px;
            color: #fff;
            font-size: 1.5rem;
            font-weight: 800;
            font-family: 'Tajawal', sans-serif;
            cursor: pointer;
            box-shadow: 0 8px 25px rgba(34, 197, 94, 0.4);
            transition: all 0.3s ease;
        }
        
        .start-game-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 30px rgba(34, 197, 94, 0.5);
        }
        
        /* Cards Grid */
        .cards-grid {
            display: none;
            grid-template-columns: repeat(5, 1fr);
            gap: 4px;
            aspect-ratio: 5/5;
            width: 100%;
        }
        
        .cards-grid.active {
            display: grid;
        }
        
        .card {
            position: relative;
            background: linear-gradient(145deg, #d4c4a8, #c9b896);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            overflow: hidden;
            min-height: 0;
        }
        
        .card:hover:not(.revealed) {
            transform: scale(1.02);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        
        .card.revealed {
            cursor: default;
        }
        
        .card.revealed.red { background: linear-gradient(145deg, #ef4444, #dc2626); }
        .card.revealed.blue { background: linear-gradient(145deg, #3b82f6, #2563eb); }
        .card.revealed.black { background: linear-gradient(145deg, #1f2937, #111827); }
        .card.revealed.neutral { background: linear-gradient(145deg, #9ca3af, #6b7280); }
        
        .card-word {
            font-size: clamp(0.55rem, 2vw, 0.8rem);
            font-weight: 700;
            color: #2d2416;
            text-align: center;
            padding: 2px;
            word-break: break-word;
            line-height: 1.2;
            z-index: 1;
        }
        
        .card.revealed .card-word {
            color: #fff;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }
        
        /* Spy View Colors */
        .card.spy-red { border: 3px solid #ef4444; box-shadow: inset 0 0 10px rgba(239, 68, 68, 0.3); }
        .card.spy-blue { border: 3px solid #3b82f6; box-shadow: inset 0 0 10px rgba(59, 130, 246, 0.3); }
        .card.spy-black { border: 3px solid #1f2937; box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5); }
        
        /* Hand Button */
        .hand-btn {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: #fbbf24;
            border: none;
            border-radius: 50%;
            font-size: 0.6rem;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10;
            transition: all 0.2s ease;
        }
        
        .hand-btn:hover {
            transform: scale(1.1);
            background: #f59e0b;
        }
        
        .card.can-vote .hand-btn {
            display: flex;
        }
        
        /* Voters Display */
        .voters-display {
            position: absolute;
            bottom: 2px;
            left: 2px;
            right: 2px;
            display: flex;
            flex-wrap: wrap;
            gap: 2px;
            justify-content: center;
            z-index: 2;
        }
        
        .voter-name {
            font-size: 0.5rem;
            padding: 1px 3px;
            border-radius: 3px;
            color: #fff;
        }
        
        .voter-name.red { background: rgba(239, 68, 68, 0.8); }
        .voter-name.blue { background: rgba(59, 130, 246, 0.8); }
        
        /* Winner Display */
        .winner-display {
            display: none;
            align-items: center;
            justify-content: center;
            flex: 1;
            text-align: center;
        }
        
        .winner-display.active {
            display: flex;
        }
        
        .winner-content-inline {
            animation: winnerPop 0.5s ease;
        }
        
        @keyframes winnerPop {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .winner-emoji-inline {
            font-size: 4rem;
            margin-bottom: 20px;
        }
        
        .winner-text-inline {
            font-size: 2rem;
            font-weight: 800;
        }
        
        .winner-text-inline.red { color: #ef4444; }
        .winner-text-inline.blue { color: #3b82f6; }
        
       /* --- Hint Box Ø§Ù„Ù…Ø·ÙˆØ± --- */
.hint-box {
    background: rgba(0,0,0,0.3);
    border: 2px solid rgba(255,255,255,0.1);
    border-radius: 12px;
    padding: 15px;
    min-height: 110px;
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.hint-input-row {
    display: none;
    gap: 10px;
}

/* Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬ÙˆÙ‡Ø±ÙŠ Ù‡Ù†Ø§ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Grid */
.hint-input-row.active {
    display: grid; 
    grid-template-columns: 1fr auto; /* Ø§Ù„Ù…Ø±Ø¨Ø¹ ÙŠØ£Ø®Ø° Ø§Ù„Ù…Ø³Ø§Ø­Ø© ÙˆØ§Ù„Ø£Ø±Ù‚Ø§Ù… Ø¨Ø¬Ø§Ù†Ø¨Ù‡ */
    align-items: center;
    row-gap: 10px;    /* Ø¥Ø¶Ø§ÙØ© Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„Ù…Ø±Ø¨Ø¹ ÙˆØ§Ù„Ø²Ø± */
    column-gap: 8px;
}

.hint-input {
    grid-column: 1 / 2; /* Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ø£ÙˆÙ„ØŒ Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£ÙˆÙ„ */
    padding: 10px 15px;
    border: 2px solid rgba(255,255,255,0.2);
    border-radius: 8px;
    background: rgba(255,255,255,0.1);
    color: #fff;
    font-size: 0.95rem;
    width: 100%;
}

.hint-count-select {
    grid-column: 2 / 3; /* Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ø£ÙˆÙ„ØŒ Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø«Ø§Ù†ÙŠ */
    padding: 8px;
    border-radius: 8px;
    background: rgba(255,255,255,0.15);
    color: #fff;
    cursor: pointer;
}

.send-hint-btn {
    grid-column: 1 / 3; /* Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ø«Ø§Ù†ÙŠØŒ ÙŠØ£Ø®Ø° Ø§Ù„Ø¹Ø±Ø¶ ÙƒØ§Ù…Ù„Ø§Ù‹ Ù„Ù„ØªÙ…ÙˆØ¶Ø¹ */
    justify-self: start; /* ÙŠØ¶Ø¹ Ø§Ù„Ø²Ø± ÙÙŠ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø³Ø·Ø± (Ø§Ù„ÙŠÙ…ÙŠÙ† ÙÙŠ RTL) */
    
    /* Ø­Ø¬Ù… Ø£ØµØºØ± */
    padding: 6px 20px; 
    font-size: 0.85rem;
    
    background: linear-gradient(135deg, #e94560, #c73e54);
    border: none;
    border-radius: 6px;
    color: #fff;
    font-weight: 700;
    cursor: pointer;
    transition: transform 0.2s;
}

.send-hint-btn:active {
    transform: scale(0.95);
}
        
        .end-turn-btn {
            display: none;
            width: 100%;
            padding: 8px;
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            color: #fff;
            font-weight: 600;
            font-family: 'Tajawal', sans-serif;
            cursor: pointer;
        }
        
        .end-turn-btn.active {
            display: block;
        }
        
        .end-turn-btn:hover {
            background: rgba(255,255,255,0.15);
        }
        
        /* Activity Log */
        .activity-log {
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            padding: 6px;
            height: 140px;
            overflow-y: auto;
            flex-shrink: 0;
        }
        
        .activity-title {
            font-size: 0.7rem;
            color: #888;
            margin-bottom: 4px;
        }
        
        .activity-item {
            font-size: 0.65rem;
            padding: 3px 6px;
            background: rgba(255,255,255,0.05);
            border-radius: 4px;
            margin-bottom: 2px;
            color: #ccc;
        }
        
        .activity-item.red { border-right: 2px solid #ef4444; }
        .activity-item.blue { border-right: 2px solid #3b82f6; }
        .activity-item.winner { background: linear-gradient(90deg, rgba(34, 197, 94, 0.2), transparent); color: #4ade80; font-weight: 700; }
        
        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal {
            background: linear-gradient(145deg, #1e293b, #0f172a);
            border-radius: 16px;
            padding: 24px;
            max-width: 400px;
            width: 100%;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .modal-title {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 16px;
            text-align: center;
        }
        
        .modal-content {
            margin-bottom: 16px;
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
        }
        
        .modal-buttons .btn {
            flex: 1;
        }
        
        /* Players Modal List */
        .players-modal-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .player-modal-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            margin-bottom: 8px;
        }
        
        .player-modal-item.offline {
            opacity: 0.5;
        }
        
        .kick-btn {
            padding: 4px 10px;
            background: #ef4444;
            border: none;
            border-radius: 6px;
            color: #fff;
            font-size: 0.75rem;
            font-family: 'Tajawal', sans-serif;
            cursor: pointer;
        }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #22c55e;
            color: #fff;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            z-index: 3000;
            transition: transform 0.3s ease;
        }
        
        .toast.active {
            transform: translateX(-50%) translateY(0);
        }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            .team-panel {
                width: 85px;
                padding: 4px;
            }
            
            .team-header {
                padding: 4px;
                font-size: 0.75rem;
            }
            
            .team-score {
                font-size: 1.2rem;
            }
            
            .player-item {
                font-size: 0.65rem;
                padding: 3px 4px;
            }
            
            .cards-grid {
                gap: 3px;
            }
            
            .card {
                border-radius: 4px;
            }
            
            .card-word {
                font-size: clamp(0.5rem, 2.5vw, 0.7rem);
            }
            
            .activity-log {
                height: 120px;
            }
            
            .top-btn {
                padding: 4px 8px;
                font-size: 0.7rem;
            }
            
            .hint-box {
                min-height: 90px;
            }
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body><!-- Main Screen -->
  <div class="main-screen" id="mainScreen">
   <div class="logo">
    Ù…Ø±Ø§Ø¨Ø·
   </div>
   <p class="subtitle">Ù„Ø¹Ø¨Ø© Ø§Ù„ÙƒÙ„Ù…Ø§Øª ÙˆØ§Ù„ØªØ®Ù…ÙŠÙ† Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠØ©</p>
   <div class="input-container"><input type="text" class="input-field" id="playerName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ" maxlength="15"> <button class="btn btn-primary" id="createGameBtn">ğŸ® Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© Ø¬Ø¯ÙŠØ¯Ø©</button>
   </div>
  </div><!-- Game Screen -->
  <div class="game-screen" id="gameScreen"><!-- Top Bar -->
   <div class="top-bar">
    <div class="top-bar-section">
     <div class="players-count" id="playersCount" onclick="showPlayersModal()">
      ğŸ‘¥ <span>0</span>
     </div><button class="top-btn top-btn-icon" id="resetGameBtn" style="display:none;">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø©</button>
    </div>
    <div class="top-bar-section" style="flex:1; justify-content:center;"><button class="top-btn top-btn-icon" id="playerNameBtn">ğŸ‘¤ <span id="currentPlayerName"></span></button>
    </div>
    <div class="top-bar-section"><button class="top-btn top-btn-icon" onclick="copyRoomLink()">ğŸ”— Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·</button>
    </div>
   </div><!-- Turn Indicator -->
   <div class="turn-indicator" id="turnIndicator">
    ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†...
   </div><!-- Main Game Content -->
   <div class="game-content"><!-- Red Team Panel -->
    <div class="team-panel red">
     <div class="team-header red">
      <div>
       Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø­Ù…Ø±
      </div>
      <div class="team-score" id="redScore">
       8
      </div>
     </div>
     <div class="team-section">
      <div class="section-title">
       ğŸ•µï¸ Ø§Ù„Ø¬Ø§Ø³ÙˆØ³
      </div>
      <div id="redSpyList"></div><button class="join-team-btn" onclick="joinTeam('red', 'spy')">+ Ø¬Ø§Ø³ÙˆØ³</button>
     </div>
     <div class="team-section">
      <div class="section-title">
       ğŸ‘¥ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙˆÙ†
      </div>
      <div id="redPlayersList"></div><button class="join-team-btn" onclick="joinTeam('red', 'player')">+ Ù„Ø§Ø¹Ø¨</button>
     </div>
    </div><!-- Center Area -->
    <div class="center-area"><!-- Start Game Button -->
     <div class="start-game-container" id="startGameContainer"><button class="start-game-btn" id="startGameBtn" onclick="startGameNow()">â–¶ï¸ Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨</button>
     </div><!-- Cards Grid -->
     <div class="cards-grid" id="cardsGrid"></div><!-- Winner Display -->
     <div class="winner-display" id="winnerDisplay">
      <div class="winner-content-inline">
       <div class="winner-emoji-inline">
        ğŸ†
       </div>
       <div class="winner-text-inline" id="winnerTextInline"></div>
      </div>
     </div><!-- Hint Box -->
     <div class="hint-box">
      <div class="hint-input-row" id="hintInputRow"><input type="text" class="hint-input" id="hintInput" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„ØªÙ„Ù…ÙŠØ­..."> <select class="hint-count-select" id="hintCountSelect"> <option value="1">1</option> <option value="2">2</option> <option value="3">3</option> <option value="4">4</option> <option value="5">5</option> <option value="6">6</option> <option value="7">7</option> <option value="8">8</option> <option value="9">9</option> </select> <button class="send-hint-btn" onclick="sendHint()">Ø¥Ø±Ø³Ø§Ù„</button>
      </div>
      <div class="current-hint" id="currentHintDisplay">
       <div class="hint-text" id="hintText"></div>
       <div class="hint-count">
        Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: <span id="remainingGuesses">0</span>
       </div>
      </div><button class="end-turn-btn" id="endTurnBtn" onclick="endTurn()">â­ï¸ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¯ÙˆØ±</button>
     </div><!-- Activity Log -->
     <div class="activity-log">
      <div class="activity-title">
       ğŸ“‹ Ø³Ø¬Ù„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
      </div>
      <div id="activityList"></div>
     </div>
    </div><!-- Blue Team Panel -->
    <div class="team-panel blue">
     <div class="team-header blue">
      <div>
       Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø²Ø±Ù‚
      </div>
      <div class="team-score" id="blueScore">
       8
      </div>
     </div>
     <div class="team-section">
      <div class="section-title">
       ğŸ•µï¸ Ø§Ù„Ø¬Ø§Ø³ÙˆØ³
      </div>
      <div id="blueSpyList"></div><button class="join-team-btn" onclick="joinTeam('blue', 'spy')">+ Ø¬Ø§Ø³ÙˆØ³</button>
     </div>
     <div class="team-section">
      <div class="section-title">
       ğŸ‘¥ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙˆÙ†
      </div>
      <div id="bluePlayersList"></div><button class="join-team-btn" onclick="joinTeam('blue', 'player')">+ Ù„Ø§Ø¹Ø¨</button>
     </div>
    </div>
   </div>
  </div><!-- Players Modal -->
  <div class="modal-overlay" id="playersModal">
   <div class="modal">
    <div class="modal-title">
     ğŸ‘¥ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙˆÙ† ÙÙŠ Ø§Ù„ØºØ±ÙØ©
    </div>
    <div class="modal-content">
     <div class="players-modal-list" id="playersModalList"></div>
    </div>
    <div class="modal-buttons"><button class="btn btn-secondary" onclick="closePlayersModal()">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
   </div>
  </div><!-- Name Change Modal -->
  <div class="modal-overlay" id="nameModal">
   <div class="modal">
    <div class="modal-title">
     ğŸ‘¤ ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù…
    </div>
    <div class="modal-content"><input type="text" class="input-field" id="newNameInput" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯" style="width:100%;">
    </div>
    <div class="modal-buttons"><button class="btn btn-secondary" onclick="closeNameModal()">Ø¥Ù„ØºØ§Ø¡</button> <button class="btn btn-primary" onclick="changeName()">Ø­ÙØ¸</button> <button class="btn btn-secondary" onclick="leaveRoom()" style="background:#ef4444;">Ø®Ø±ÙˆØ¬</button>
    </div>
   </div>
  </div><!-- Toast -->
  <div class="toast" id="toast"></div>
  <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBLyoIoXp2aJCnhFqIFufMVBz0fzCS-FYY",
            authDomain: "game-303eb.firebaseapp.com",
            databaseURL: "https://game-303eb-default-rtdb.firebaseio.com",
            projectId: "game-303eb",
            storageBucket: "game-303eb.firebasestorage.app",
            messagingSenderId: "22261863844",
            appId: "1:22261863844:web:66f8541079b9025ec69d31"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // Arabic Words
        const arabicWords = [
            "Ø´Ù…Ø³", "Ù‚Ù…Ø±", "Ù†Ø¬Ù…", "Ø³Ù…Ø§Ø¡", "Ø£Ø±Ø¶", "Ø¨Ø­Ø±", "Ø¬Ø¨Ù„", "Ù†Ù‡Ø±", "Ø´Ø¬Ø±Ø©", "ÙˆØ±Ø¯Ø©",
            "ÙƒØªØ§Ø¨", "Ù‚Ù„Ù…", "ÙˆØ±Ù‚Ø©", "Ù…Ø¯Ø±Ø³Ø©", "Ù…Ø¹Ù„Ù…", "Ø·Ø§Ù„Ø¨", "ØµÙ", "Ø¯Ø±Ø³", "Ø§Ù…ØªØ­Ø§Ù†", "Ø´Ù‡Ø§Ø¯Ø©",
            "Ø¨ÙŠØª", "Ø¨Ø§Ø¨", "Ù†Ø§ÙØ°Ø©", "Ø³Ù‚Ù", "Ø¬Ø¯Ø§Ø±", "ØºØ±ÙØ©", "Ù…Ø·Ø¨Ø®", "Ø­Ù…Ø§Ù…", "Ø³Ø±ÙŠØ±", "ÙƒØ±Ø³ÙŠ",
            "Ø³ÙŠØ§Ø±Ø©", "Ø·Ø§Ø¦Ø±Ø©", "Ù‚Ø·Ø§Ø±", "Ø³ÙÙŠÙ†Ø©", "Ø¯Ø±Ø§Ø¬Ø©", "Ø·Ø±ÙŠÙ‚", "Ø¬Ø³Ø±", "Ù…Ø·Ø§Ø±", "Ù…Ø­Ø·Ø©", "Ø´Ø§Ø±Ø¹",
            "Ø£Ø³Ø¯", "Ù†Ù…Ø±", "ÙÙŠÙ„", "Ø²Ø±Ø§ÙØ©", "Ù‚Ø±Ø¯", "Ø·Ø§Ø¦Ø±", "Ø³Ù…ÙƒØ©", "Ù‚Ø·", "ÙƒÙ„Ø¨", "Ø­ØµØ§Ù†",
            "ØªÙØ§Ø­Ø©", "Ù…ÙˆØ²Ø©", "Ø¨Ø±ØªÙ‚Ø§Ù„", "Ø¹Ù†Ø¨", "ÙØ±Ø§ÙˆÙ„Ø©", "Ø¨Ø·ÙŠØ®", "Ø±Ù…Ø§Ù†", "ØªÙŠÙ†", "Ø²ÙŠØªÙˆÙ†", "Ù†Ø®Ù„Ø©",
            "Ø®Ø¨Ø²", "Ø£Ø±Ø²", "Ù„Ø­Ù…", "Ø¯Ø¬Ø§Ø¬", "Ø³Ù…Ùƒ", "Ø­Ù„ÙŠØ¨", "Ø¬Ø¨Ù†", "Ø¨ÙŠØ¶", "Ø²ÙŠØª", "Ù…Ù„Ø­",
            "Ø·Ø¨ÙŠØ¨", "Ù…Ù‡Ù†Ø¯Ø³", "Ù…Ø­Ø§Ù…ÙŠ", "Ø´Ø±Ø·ÙŠ", "Ø¬Ù†Ø¯ÙŠ", "Ø·ÙŠØ§Ø±", "Ø¨Ø­Ø§Ø±", "ÙÙ„Ø§Ø­", "Ù†Ø¬Ø§Ø±", "Ø®Ø¨Ø§Ø²",
            "ÙƒØ±Ø©", "Ù…Ù„Ø¹Ø¨", "ÙØ±ÙŠÙ‚", "Ù‡Ø¯Ù", "Ø­ÙƒÙ…", "Ø¨Ø·ÙˆÙ„Ø©", "ÙƒØ£Ø³", "Ø°Ù‡Ø¨", "ÙØ¶Ø©", "Ø¨Ø±ÙˆÙ†Ø²",
            "Ù‡Ø§ØªÙ", "ØªÙ„ÙØ§Ø²", "Ø­Ø§Ø³ÙˆØ¨", "Ø¥Ù†ØªØ±Ù†Øª", "ÙƒØ§Ù…ÙŠØ±Ø§", "Ø³Ø§Ø¹Ø©", "Ù…ÙØªØ§Ø­", "Ù…Ø­ÙØ¸Ø©", "Ù†Ø¸Ø§Ø±Ø©", "Ù…Ø¸Ù„Ø©",
            "ØµÙŠÙ", "Ø´ØªØ§Ø¡", "Ø±Ø¨ÙŠØ¹", "Ø®Ø±ÙŠÙ", "Ù…Ø·Ø±", "Ø«Ù„Ø¬", "Ø±ÙŠØ§Ø­", "ØºÙŠÙˆÙ…", "Ø¨Ø±Ù‚", "Ø±Ø¹Ø¯",
            "Ø­Ø¨", "Ø³Ù„Ø§Ù…", "Ø­Ø±Ø¨", "ØµØ¯Ø§Ù‚Ø©", "Ø¹Ø§Ø¦Ù„Ø©", "Ø£Ù…", "Ø£Ø¨", "Ø£Ø®", "Ø£Ø®Øª", "Ø¬Ø¯"
        ];

        // Game State
        let currentRoom = null;
        let currentPlayer = null;
        let playerId = null;
        let isCreator = false;
        let gameRef = null;
        let presenceRef = null;

        // Generate unique player ID
        function generateId() {
            return Math.random().toString(36).substr(2, 9);
        }

        // Generate room code
        function generateRoomCode() {
            return Math.random().toString(36).substr(2, 6).toUpperCase();
        }

        // Check URL for room code
        function checkUrlForRoom() {
            const urlParams = new URLSearchParams(window.location.search);
            const roomCode = urlParams.get('room');
            if (roomCode) {
                // Change button to join room
                const btn = document.getElementById('createGameBtn');
                btn.innerHTML = 'ğŸ® Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„ØºØ±ÙØ©';
                btn.onclick = () => joinExistingRoom(roomCode);
            }
        }

        // Join existing room
        async function joinExistingRoom(roomCode) {
            const name = document.getElementById('playerName').value.trim();

            if (!name) {
                showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù…Ùƒ');
                return;
            }

            const snapshot = await db.ref('rooms/' + roomCode).once('value');
            if (!snapshot.exists()) {
                showToast('Ø§Ù„ØºØ±ÙØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
                return;
            }

            playerId = generateId();
            currentPlayer = { id: playerId, name: name, team: null, role: null, online: true };
            currentRoom = roomCode;

            const gameData = snapshot.val();
            isCreator = gameData.creator === playerId;

            await db.ref('rooms/' + roomCode + '/players/' + playerId).set(currentPlayer);
            
            setupPresence(roomCode);
            startGame(roomCode);
        }

        // Show toast message
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('active');
            setTimeout(() => toast.classList.remove('active'), 3000);
        }

        // Create new game
        document.getElementById('createGameBtn').addEventListener('click', async () => {
            const name = document.getElementById('playerName').value.trim();
            if (!name) {
                showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù…Ùƒ');
                return;
            }

            playerId = generateId();
            currentPlayer = { id: playerId, name: name, team: null, role: null, online: true };
            isCreator = true;

            const roomCode = generateRoomCode();
            currentRoom = roomCode;

            // Generate cards
            const shuffledWords = [...arabicWords].sort(() => Math.random() - 0.5).slice(0, 25);
            const startTeam = Math.random() < 0.5 ? 'red' : 'blue';
            const cardColors = generateCardColors(startTeam);

            const gameData = {
                roomCode: roomCode,
                creator: playerId,
                createdAt: Date.now(),
                status: 'waiting',
                currentTurn: startTeam,
                phase: 'hint',
                cards: shuffledWords.map((word, i) => ({
                    word: word,
                    color: cardColors[i],
                    revealed: false,
                    votes: {}
                })),
                hint: null,
                hintCount: 0,
                remainingGuesses: 0,
                redScore: startTeam === 'red' ? 9 : 8,
                blueScore: startTeam === 'blue' ? 9 : 8,
                players: {
                    [playerId]: currentPlayer
                },
                activity: [],
                winner: null
            };

            await db.ref('rooms/' + roomCode).set(gameData);
            
            setupPresence(roomCode);
            startGame(roomCode);
        });

        // Generate card colors
        function generateCardColors(startTeam) {
            const colors = [];
            const firstTeamCount = 9;
            const secondTeamCount = 8;

            // Add colors based on start team
            for (let i = 0; i < firstTeamCount; i++) colors.push(startTeam);
            for (let i = 0; i < secondTeamCount; i++) colors.push(startTeam === 'red' ? 'blue' : 'red');
            colors.push('black');
            for (let i = 0; i < 7; i++) colors.push('neutral');

            // Shuffle
            return colors.sort(() => Math.random() - 0.5);
        }

        // Setup presence system
        function setupPresence(roomCode) {
            presenceRef = db.ref('rooms/' + roomCode + '/players/' + playerId);
            
            presenceRef.onDisconnect().update({ online: false });
            
            // Keep alive
            setInterval(() => {
                if (presenceRef) {
                    presenceRef.update({ online: true, lastSeen: Date.now() });
                }
            }, 5000);
        }

        // Start game and listen for updates
        function startGame(roomCode) {
            document.getElementById('mainScreen').style.display = 'none';
            document.getElementById('gameScreen').style.display = 'flex';

            gameRef = db.ref('rooms/' + roomCode);
            
            gameRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    updateGameUI(data);
                }
            });

            // Update URL
            window.history.replaceState({}, '', '?room=' + roomCode);

            document.getElementById('currentPlayerName').textContent = currentPlayer.name;

            // Show reset button for creator
            if (isCreator) {
                document.getElementById('resetGameBtn').style.display = 'block';
            }
        }

        // Start game now
        async function startGameNow() {
            if (!isCreator) return;
            
            await db.ref(`rooms/${currentRoom}`).update({
                status: 'playing'
            });
        }

        // Update game UI
        function updateGameUI(data) {
            // Update players count
            const players = data.players || {};
            const playerCount = Object.keys(players).length;
            document.getElementById('playersCount').querySelector('span').textContent = playerCount;

            // Update current player data
            if (players[playerId]) {
                currentPlayer = players[playerId];
            }

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø·Ø±Ø¯ (ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„Ù…Ù†Ø¹ Ø§Ù„Ø·Ø±Ø¯ Ø¹Ù†Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø£ÙˆÙ„ Ù…Ø±Ø©)
if (currentRoom && currentPlayer && !players[playerId] && data.status !== 'waiting') {
    showToast('ØªÙ… Ø·Ø±Ø¯Ùƒ Ù…Ù† Ø§Ù„ØºØ±ÙØ©');
    leaveRoom();
    return;
}

            // Update scores
            document.getElementById('redScore').textContent = data.redScore;
            document.getElementById('blueScore').textContent = data.blueScore;

            // Update turn indicator
            updateTurnIndicator(data);

            // Update team lists
            updateTeamLists(players);

            // Show/hide start button
            if (isCreator && data.status === 'waiting') {
                document.getElementById('startGameContainer').style.display = 'flex';
                document.getElementById('cardsGrid').classList.remove('active');
                document.getElementById('winnerDisplay').classList.remove('active');
            } else if (data.status === 'playing' && !data.winner) {
                document.getElementById('startGameContainer').style.display = 'none';
                document.getElementById('cardsGrid').classList.add('active');
                document.getElementById('winnerDisplay').classList.remove('active');
                updateCards(data);
            } else if (data.winner) {
                // Winner state will be handled after revealing cards
            }

            // Update hint section
            updateHintSection(data);

            // Update activity log
            updateActivityLog(data.activity || []);

            // Update creator status
            isCreator = data.creator === playerId;
            document.getElementById('resetGameBtn').style.display = isCreator ? 'block' : 'none';
        }

        // Update turn indicator
        function updateTurnIndicator(data) {
            const indicator = document.getElementById('turnIndicator');
            
            if (data.winner) {
                indicator.textContent = data.winner === 'red' ? 'ğŸ† ÙØ§Ø² Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø­Ù…Ø±!' : 'ğŸ† ÙØ§Ø² Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø²Ø±Ù‚!';
                indicator.className = 'turn-indicator turn-' + data.winner;
                return;
            }

            if (data.status === 'waiting') {
                indicator.textContent = 'ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†...';
                indicator.className = 'turn-indicator';
                return;
            }

            const teamName = data.currentTurn === 'red' ? 'Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø­Ù…Ø±' : 'Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø²Ø±Ù‚';
            const phaseText = data.phase === 'hint' ? 'ğŸ•µï¸ Ø¯ÙˆØ± Ø§Ù„Ø¬Ø§Ø³ÙˆØ³' : 'ğŸ‘¥ Ø¯ÙˆØ± Ø§Ù„ØªØ®Ù…ÙŠÙ†';
            indicator.textContent = `${teamName} - ${phaseText}`;
            indicator.className = 'turn-indicator turn-' + data.currentTurn;
        }

        // Update team lists
        function updateTeamLists(players) {
            const redSpyList = document.getElementById('redSpyList');
            const redPlayersList = document.getElementById('redPlayersList');
            const blueSpyList = document.getElementById('blueSpyList');
            const bluePlayersList = document.getElementById('bluePlayersList');

            redSpyList.innerHTML = '';
            redPlayersList.innerHTML = '';
            blueSpyList.innerHTML = '';
            bluePlayersList.innerHTML = '';

            Object.values(players).forEach(player => {
                if (!player.team) return;

                const div = document.createElement('div');
                div.className = `player-item ${player.team} ${player.online ? '' : 'offline'}`;
                div.innerHTML = `
                    <span>${player.name}</span>
                    ${!player.online ? '<span style="font-size:0.6rem;">ğŸ“´</span>' : ''}
                `;

                if (player.team === 'red') {
                    if (player.role === 'spy') redSpyList.appendChild(div);
                    else redPlayersList.appendChild(div);
                } else {
                    if (player.role === 'spy') blueSpyList.appendChild(div);
                    else bluePlayersList.appendChild(div);
                }
            });
        }

        // Update cards
        function updateCards(data) {
            const grid = document.getElementById('cardsGrid');
            const isSpy = currentPlayer.role === 'spy';
            const canVote = currentPlayer.role === 'player' && 
                           currentPlayer.team === data.currentTurn && 
                           data.phase === 'guess' &&
                           !data.winner;

            grid.innerHTML = '';

            data.cards.forEach((card, index) => {
                const div = document.createElement('div');
                let classes = 'card';

                if (card.revealed) {
                    classes += ` revealed ${card.color}`;
                } else if (isSpy) {
                    classes += ` spy-${card.color}`;
                }

                if (canVote && !card.revealed) {
                    classes += ' can-vote';
                }

                div.className = classes;

                // Voters display
                const votes = card.votes || {};
                const voterNames = Object.values(votes).map(v => 
                    `<span class="voter-name ${v.team}">${v.name}</span>`
                ).join('');

               div.innerHTML = `
    <button class="hand-btn" onclick="confirmVote(${index}, event)">ğŸ‘†</button>
    <span class="card-word">${card.word}</span>
    <div class="voters-display">${voterNames}</div>
`;

// Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§: Ø§Ø³ØªØ®Ø¯Ø§Ù… onclick Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† addEventListener Ù„Ù…Ù†Ø¹ ØªØ¯Ø§Ø®Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª
div.onclick = (e) => {
    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„ÙŠØ¯ØŒ Ù„Ø§ ØªÙØ¹Ù„ Ø´ÙŠØ¦Ø§Ù‹ Ù‡Ù†Ø§ (Ù„Ø£Ù† Ø²Ø± Ø§Ù„ÙŠØ¯ Ù„Ù‡ ÙˆØ¸ÙŠÙØ© Ù…Ù†ÙØµÙ„Ø©)
    if (e.target.classList.contains('hand-btn')) return;

    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„ÙƒØ±Øª Ù†ÙØ³Ù‡ØŒ Ù‚Ù… Ø¨Ø§Ù„ØªØµÙˆÙŠØª (Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø§Ø³Ù…)
    toggleVote(index, data);
};

                grid.appendChild(div);
            });
        }

        // Toggle vote on card
        async function toggleVote(index, data) {
            if (currentPlayer.role !== 'player' || !currentPlayer.team) return;
            if (data.currentTurn !== currentPlayer.team) return;
            if (data.phase !== 'guess') return;
            if (data.cards[index].revealed) return;
            if (data.winner) return;

            const voteRef = db.ref(`rooms/${currentRoom}/cards/${index}/votes/${playerId}`);
            const snapshot = await voteRef.once('value');

            if (snapshot.exists()) {
                await voteRef.remove();
            } else {
                await voteRef.set({
                    name: currentPlayer.name,
                    team: currentPlayer.team
                });
            }
        }

        // Confirm vote and reveal card
        async function confirmVote(index, event) {
            event.stopPropagation();

            const snapshot = await db.ref(`rooms/${currentRoom}`).once('value');
            const data = snapshot.val();

            if (currentPlayer.role !== 'player' || !currentPlayer.team) return;
            if (data.currentTurn !== currentPlayer.team) return;
            if (data.phase !== 'guess') return;
            if (data.cards[index].revealed) return;
            if (data.winner) return;

            const card = data.cards[index];
            const updates = {};

            // Reveal card
            updates[`cards/${index}/revealed`] = true;
            updates[`cards/${index}/votes`] = {};

            // Add activity
            const activity = data.activity || [];
            activity.push({
                type: 'guess',
                team: currentPlayer.team,
                player: currentPlayer.name,
                word: card.word,
                result: card.color,
                time: Date.now()
            });

            // Calculate new remaining guesses
            let newRemaining = data.remainingGuesses - 1;

            // Check card color and apply game logic
            if (card.color === 'black') {
                // Black card - instant loss for current team
                const winner = currentPlayer.team === 'red' ? 'blue' : 'red';
                updates['winner'] = winner;
                updates['winReason'] = 'black';
                activity.push({
                    type: 'winner',
                    team: winner,
                    reason: 'Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø®ØµÙ… Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø³ÙˆØ¯Ø§Ø¡',
                    time: Date.now()
                });
            } else if (card.color === currentPlayer.team) {
                // Correct team card - decrease team score and continue if guesses remain
                const scoreKey = currentPlayer.team + 'Score';
                const newScore = data[scoreKey] - 1;
                updates[scoreKey] = newScore;

                if (newScore === 0) {
                    // Team completed all words - WIN
                    updates['winner'] = currentPlayer.team;
                    updates['winReason'] = 'complete';
                    activity.push({
                        type: 'winner',
                        team: currentPlayer.team,
                        reason: 'Ø£ÙƒÙ…Ù„ Ø¬Ù…ÙŠØ¹ ÙƒÙ„Ù…Ø§ØªÙ‡',
                        time: Date.now()
                    });
                } else if (newRemaining < 0) {
                    // No more guesses - end turn
                    updates['currentTurn'] = currentPlayer.team === 'red' ? 'blue' : 'red';
                    updates['phase'] = 'hint';
                    updates['hint'] = null;
                    updates['hintCount'] = 0;
                    updates['remainingGuesses'] = 0;
                } else {
                    // Continue guessing
                    updates['remainingGuesses'] = newRemaining;
                }
            } else if (card.color === 'neutral') {
                // Neutral card - end turn immediately
                updates['currentTurn'] = currentPlayer.team === 'red' ? 'blue' : 'red';
                updates['phase'] = 'hint';
                updates['hint'] = null;
                updates['hintCount'] = 0;
                updates['remainingGuesses'] = 0;
            } else {
                // Enemy team card - give point to enemy and end turn
                const enemyTeam = currentPlayer.team === 'red' ? 'blue' : 'red';
                const enemyScoreKey = enemyTeam + 'Score';
                const newEnemyScore = data[enemyScoreKey] - 1;
                updates[enemyScoreKey] = newEnemyScore;

                if (newEnemyScore === 0) {
                    // Enemy wins
                    updates['winner'] = enemyTeam;
                    updates['winReason'] = 'complete';
                    activity.push({
                        type: 'winner',
                        team: enemyTeam,
                        reason: 'Ø£ÙƒÙ…Ù„ Ø¬Ù…ÙŠØ¹ ÙƒÙ„Ù…Ø§ØªÙ‡ Ø¨Ù…Ø³Ø§Ø¹Ø¯Ø© Ø§Ù„Ø®ØµÙ…',
                        time: Date.now()
                    });
                } else {
                    // Switch turn to enemy team
                    updates['currentTurn'] = enemyTeam;
                    updates['phase'] = 'hint';
                    updates['hint'] = null;
                    updates['hintCount'] = 0;
                    updates['remainingGuesses'] = 0;
                }
            }

            updates['activity'] = activity;
            await db.ref(`rooms/${currentRoom}`).update(updates);

            // If there's a winner, show cards for 3 seconds then show winner
            if (updates['winner']) {
                setTimeout(() => {
                    showWinnerDisplay(updates['winner']);
                }, 3000);
            }
        }

        // Show winner display
        function showWinnerDisplay(winner) {
            document.getElementById('cardsGrid').classList.remove('active');
            document.getElementById('winnerDisplay').classList.add('active');
            
            const winnerText = document.getElementById('winnerTextInline');
            winnerText.textContent = winner === 'red' ? 'ÙØ§Ø² Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø­Ù…Ø±!' : 'ÙØ§Ø² Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø²Ø±Ù‚!';
            winnerText.className = 'winner-text-inline ' + winner;
        }

        // Update hint section
        function updateHintSection(data) {
            const hintInputRow = document.getElementById('hintInputRow');
            const currentHintDisplay = document.getElementById('currentHintDisplay');
            const endTurnBtn = document.getElementById('endTurnBtn');

            if (data.winner || data.status === 'waiting') {
                hintInputRow.classList.remove('active');
                currentHintDisplay.classList.remove('active');
                endTurnBtn.classList.remove('active');
                return;
            }

            // Check if current player is spy of current team in hint phase
            const isCurrentSpy = currentPlayer.role === 'spy' && 
                                currentPlayer.team === data.currentTurn &&
                                data.phase === 'hint';

            // Check if current player is player of current team in guess phase
            const isCurrentPlayer = currentPlayer.role === 'player' && 
                                   currentPlayer.team === data.currentTurn &&
                                   data.phase === 'guess';

            if (isCurrentSpy) {
                hintInputRow.classList.add('active');
            } else {
                hintInputRow.classList.remove('active');
            }

            if (data.hint) {
                currentHintDisplay.classList.add('active');
                document.getElementById('hintText').textContent = data.hint;
                document.getElementById('remainingGuesses').textContent = data.remainingGuesses;
            } else {
                currentHintDisplay.classList.remove('active');
            }

            if (isCurrentPlayer) {
                endTurnBtn.classList.add('active');
            } else {
                endTurnBtn.classList.remove('active');
            }
        }

        // Send hint
        async function sendHint() {
    const hintInput = document.getElementById('hintInput');
    const hintCount = parseInt(document.getElementById('hintCountSelect').value);
    const hint = hintInput.value.trim();

    if (!hint) {
        showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ØªÙ„Ù…ÙŠØ­');
        return;
    }

    const snapshot = await db.ref(`rooms/${currentRoom}`).once('value');
    const data = snapshot.val();
    const activity = data.activity || [];

    activity.push({
        type: 'hint',
        team: currentPlayer.team,
        player: currentPlayer.name,
        hint: hint,
        count: hintCount,
        time: Date.now()
    });

    // Ø§Ù„ØªØ­Ø¯ÙŠØ« Ù‡Ù†Ø§: ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù€ +1 Ù„ØªÙƒÙˆÙ† Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ù…Ø³Ø§ÙˆÙŠØ© Ù„Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø®ØªØ§Ø± ÙÙ‚Ø·
    await db.ref(`rooms/${currentRoom}`).update({
        hint: hint,
        hintCount: hintCount,
        remainingGuesses: hintCount, 
        phase: 'guess',
        activity: activity
    });

    hintInput.value = '';
}

        // End turn manually
        async function endTurn() {
    const snapshot = await db.ref(`rooms/${currentRoom}`).once('value');
    const data = snapshot.val();

    if (data.currentTurn !== currentPlayer.team) return;
    if (data.phase !== 'guess') return;

    const nextTeam = currentPlayer.team === 'red' ? 'blue' : 'red';

    const updates = {
        currentTurn: nextTeam,
        phase: 'hint',
        hint: null,
        hintCount: 0,
        remainingGuesses: 0
    };

    // Ù…ÙŠØ²Ø© Ø¥Ø¶Ø§ÙÙŠØ©: Ù…Ø³Ø­ Ø§Ù„ØªØµÙˆÙŠØªØ§Øª Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙƒØ±ÙˆØª Ø¹Ù†Ø¯ ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø¯ÙˆØ±
    data.cards.forEach((_, index) => {
        updates[`cards/${index}/votes`] = {};
    });

    await db.ref(`rooms/${currentRoom}`).update(updates);
}

        // Update activity log
        function updateActivityLog(activity) {
            const list = document.getElementById('activityList');
            list.innerHTML = '';

            [...activity].reverse().slice(0, 20).forEach(item => {
                const div = document.createElement('div');
                
                if (item.type === 'winner') {
                    div.className = 'activity-item winner';
                    div.textContent = `ğŸ† ${item.team === 'red' ? 'Ø§Ù„Ø£Ø­Ù…Ø±' : 'Ø§Ù„Ø£Ø²Ø±Ù‚'} ÙØ§Ø²! - ${item.reason}`;
                } else if (item.type === 'hint') {
                    div.className = 'activity-item ' + item.team;
                    div.textContent = `ğŸ•µï¸ ${item.player}: "${item.hint}" (${item.count})`;
                } else if (item.type === 'guess') {
                    div.className = 'activity-item ' + item.team;
                    const resultEmoji = item.result === item.team ? 'âœ…' : (item.result === 'black' ? 'ğŸ’€' : 'âŒ');
                    div.textContent = `${resultEmoji} ${item.player} Ø§Ø®ØªØ§Ø± "${item.word}"`;
                }

                list.appendChild(div);
            });
        }

        // Join team
        async function joinTeam(team, role) {
            if (currentPlayer.team && currentPlayer.team !== team) {
                // Can switch teams
            }

            await db.ref(`rooms/${currentRoom}/players/${playerId}`).update({
                team: team,
                role: role
            });

            currentPlayer.team = team;
            currentPlayer.role = role;
        }

        // Show players modal
        async function showPlayersModal() {
            const snapshot = await db.ref(`rooms/${currentRoom}`).once('value');
            const data = snapshot.val();
            const players = data.players || {};

            const list = document.getElementById('playersModalList');
            list.innerHTML = '';

            Object.entries(players).forEach(([id, player]) => {
                const div = document.createElement('div');
                div.className = `player-modal-item ${player.online ? '' : 'offline'}`;
                
                let teamText = 'Ø¨Ø¯ÙˆÙ† ÙØ±ÙŠÙ‚';
                if (player.team) {
                    teamText = player.team === 'red' ? 'Ø£Ø­Ù…Ø±' : 'Ø£Ø²Ø±Ù‚';
                    teamText += player.role === 'spy' ? ' (Ø¬Ø§Ø³ÙˆØ³)' : ' (Ù„Ø§Ø¹Ø¨)';
                }

                div.innerHTML = `
                    <div>
                        <strong>${player.name}</strong>
                        <small style="display:block;color:#888;">${teamText}</small>
                    </div>
                    ${isCreator && id !== playerId ? `<button class="kick-btn" onclick="kickPlayer('${id}')">Ø·Ø±Ø¯</button>` : ''}
                `;

                list.appendChild(div);
            });

            document.getElementById('playersModal').classList.add('active');
        }

        function closePlayersModal() {
            document.getElementById('playersModal').classList.remove('active');
        }

        // Kick player
        async function kickPlayer(id) {
            if (!isCreator) return;
            await db.ref(`rooms/${currentRoom}/players/${id}`).remove();
            showToast('ØªÙ… Ø·Ø±Ø¯ Ø§Ù„Ù„Ø§Ø¹Ø¨');
        }

        // Name modal
        document.getElementById('playerNameBtn').addEventListener('click', () => {
    const input = document.getElementById('newNameInput');
    
    // 1. ÙˆØ¶Ø¹ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙŠ Ù…Ø±Ø¨Ø¹ Ø§Ù„Ù†Øµ
    input.value = currentPlayer.name;
    
    // 2. Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ (Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©)
    document.getElementById('nameModal').classList.add('active');
    
    // 3. ØªØ£Ø®ÙŠØ± Ø¨Ø³ÙŠØ· Ù„Ø¶Ù…Ø§Ù† Ø¸Ù‡ÙˆØ± Ø§Ù„Ù†Ø§ÙØ°Ø© Ø«Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†Øµ
    setTimeout(() => {
        input.focus();      // ØªÙØ¹ÙŠÙ„ Ù…Ø±Ø¨Ø¹ Ø§Ù„Ù†Øµ
        input.select();     // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†Øµ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
        
        // Ø³Ø·Ø± Ø¥Ø¶Ø§ÙÙŠ Ù„Ø¶Ù…Ø§Ù† Ø¹Ù…Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ù‡ÙˆØ§ØªÙ (Android/iOS)
        input.setSelectionRange(0, input.value.length);
    }, 350); 
});

        function closeNameModal() {
            document.getElementById('nameModal').classList.remove('active');
        }

        async function changeName() {
            const newName = document.getElementById('newNameInput').value.trim();
            if (!newName) {
                showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù…');
                return;
            }

            await db.ref(`rooms/${currentRoom}/players/${playerId}`).update({ name: newName });
            currentPlayer.name = newName;
            document.getElementById('currentPlayerName').textContent = newName;
            closeNameModal();
        }

        // Leave room
        function leaveRoom() {
            if (gameRef) {
                gameRef.off();
            }
            if (presenceRef) {
                presenceRef.remove();
            }
            currentRoom = null;
            currentPlayer = null;
            document.getElementById('gameScreen').style.display = 'none';
            document.getElementById('mainScreen').style.display = 'flex';
            closeNameModal();
            window.history.replaceState({}, '', window.location.pathname);
        }

        // Copy room link
        function copyRoomLink() {
            const link = `https://mayadinq8.github.io/marabit/?room=${currentRoom}`;
            navigator.clipboard.writeText(link).then(() => {
                showToast('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·');
            }).catch(() => {
                showToast('ÙØ´Ù„ Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·');
            });
        }

        // Reset game
        document.getElementById('resetGameBtn').addEventListener('click', async () => {
            if (!isCreator) return;

            const snapshot = await db.ref(`rooms/${currentRoom}`).once('value');
            const data = snapshot.val();

            const shuffledWords = [...arabicWords].sort(() => Math.random() - 0.5).slice(0, 25);
            const startTeam = Math.random() < 0.5 ? 'red' : 'blue';
            const cardColors = generateCardColors(startTeam);

            await db.ref(`rooms/${currentRoom}`).update({
                currentTurn: startTeam,
                phase: 'hint',
                cards: shuffledWords.map((word, i) => ({
                    word: word,
                    color: cardColors[i],
                    revealed: false,
                    votes: {}
                })),
                hint: null,
                hintCount: 0,
                remainingGuesses: 0,
                redScore: startTeam === 'red' ? 9 : 8,
                blueScore: startTeam === 'blue' ? 9 : 8,
                activity: [],
                winner: null,
                winReason: null,
                status: 'waiting'
            });

            // Reset display
            document.getElementById('winnerDisplay').classList.remove('active');
            document.getElementById('cardsGrid').classList.remove('active');
            document.getElementById('startGameContainer').style.display = 'flex';
            
            showToast('ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©');
        });

        // Initialize
        checkUrlForRoom();
        
        // Initialize Element SDK
        if (window.elementSdk) {
            window.elementSdk.init({
                defaultConfig: {},
                onConfigChange: async () => {},
                mapToCapabilities: () => ({
                    recolorables: [],
                    borderables: [],
                    fontEditable: undefined,
                    fontSizeable: undefined
                }),
                mapToEditPanelValues: () => new Map()
            });
        }
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9c11362d92fc51c2',t:'MTc2ODkzOTc4OC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>

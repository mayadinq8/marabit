<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø±Ø§Ø¨Ø·</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        body {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100%;
            color: #333;
        }
        
        html, body {
            height: 100%;
        }
        
        .container {
            max-width: 100vw;
            margin: 0 auto;
            padding: 10px;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        /* Ø´Ø§Ø´Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© */
        .start-screen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            background: white;
            border-radius: 20px;
            padding: 40px 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .game-title {
            font-size: 3rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        
        .name-input {
            width: 100%;
            max-width: 300px;
            padding: 15px 20px;
            font-size: 1.2rem;
            border: 2px solid #ddd;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
            outline: none;
            transition: border-color 0.3s;
        }
        
        .name-input:focus {
            border-color: #667eea;
        }
        
        .start-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.3rem;
            border-radius: 15px;
            cursor: pointer;
            transition: transform 0.2s;
            font-weight: bold;
        }
        
        .start-btn:hover {
            transform: translateY(-2px);
        }
        
        /* Ø´Ø§Ø´Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© */
        .game-screen {
            display: none;
            height: 100%;
            flex-direction: column;
        }
        
        /* Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¹Ù„ÙˆÙŠ */
        .toolbar {
            background: rgba(255,255,255,0.95);
            padding: 10px;
            border-radius: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .toolbar-item {
            display: flex;
            align-items: center;
            gap: 5px;
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 10px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        
        .toolbar-item:hover {
            background: #e9ecef;
            transform: translateY(-1px);
        }
        
        .toolbar-btn {
            background: #28a745;
            color: white;
            border: 2px solid #28a745;
            padding: 8px 15px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
            font-weight: bold;
        }
        
        .toolbar-btn:hover {
            background: #218838;
            border-color: #218838;
            transform: translateY(-1px);
        }
        
        .toolbar-btn.secondary {
            background: #ffc107;
            color: #333;
            border-color: #ffc107;
        }
        
        .toolbar-btn.secondary:hover {
            background: #e0a800;
            border-color: #e0a800;
        }
        
        .player-name-btn {
            background: #f8f9fa;
            border: 2px solid #28a745;
            color: #333;
            padding: 8px 12px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
            font-weight: bold;
        }
        
        .player-name-btn:hover {
            background: #e8f5e8;
            transform: translateY(-1px);
        }
        
        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù„Ø¹Ø¨ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© */
        .game-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        /* Ø´Ø¨ÙƒØ© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .card {
            aspect-ratio: 1.2;
            background: #f5f5dc;
            border: 2px solid #ddd;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            font-size: 0.8rem;
            font-weight: bold;
            text-align: center;
            padding: 5px;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .card.revealed {
            color: white;
        }
        
        .card.red {
            background: #dc3545;
        }
        
        .card.blue {
            background: #007bff;
        }
        
        .card.black {
            background: #343a40;
        }
        
        .card.neutral {
            background: #6c757d;
        }
        
        .hand-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #ffc107;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            font-size: 0.8rem;
            display: none;
        }
        
        .card.can-select .hand-btn {
            display: block;
        }
        
        .voters {
            font-size: 0.6rem;
            margin-top: 5px;
        }
        
        .voter {
            display: inline-block;
            margin: 2px;
            padding: 2px 5px;
            border-radius: 5px;
            color: white;
        }
        
        .voter.red {
            background: #dc3545;
        }
        
        .voter.blue {
            background: #007bff;
        }
        
        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ÙØ±Ù‚ ÙˆØ§Ù„Ø³Ø¬Ù„ */
        .bottom-area {
            display: flex;
            gap: 10px;
            height: 200px;
        }
        
        .team-panel {
            flex: 1;
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 10px;
            overflow-y: auto;
        }
        
        .team-panel.red {
            border-top: 4px solid #dc3545;
        }
        
        .team-panel.blue {
            border-top: 4px solid #007bff;
        }
        
        .team-title {
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
            font-size: 1rem;
        }
        
        .team-section {
            margin-bottom: 15px;
        }
        
        .section-title {
            font-size: 0.8rem;
            font-weight: bold;
            margin-bottom: 5px;
            color: #666;
        }
        
        .player-item {
            background: #f8f9fa;
            padding: 5px 8px;
            margin: 3px 0;
            border-radius: 8px;
            font-size: 0.8rem;
            display: inline-flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(0, 0, 0, 0.15);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            width: fit-content;
            margin-right: 5px;
            margin-bottom: 5px;
        }
        
        .player-item.offline {
            opacity: 0.5;
        }
        
        .kick-btn {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 2px 6px;
            font-size: 0.7rem;
            cursor: pointer;
        }
        
        .log-panel {
            flex: 1;
            background: rgba(240,240,240,0.95);
            border-radius: 15px;
            padding: 10px;
            overflow-y: auto;
        }
        
        .log-title {
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
            font-size: 1rem;
        }
        
        .log-entry {
            background: white;
            padding: 8px;
            margin: 5px 0;
            border-radius: 8px;
            font-size: 0.8rem;
            border-left: 4px solid #ddd;
        }
        
        .log-entry.red {
            border-left-color: #dc3545;
        }
        
        .log-entry.blue {
            border-left-color: #007bff;
        }
        
        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ØªÙ„Ù…ÙŠØ­ */
        .hint-area {
            background: rgba(255,255,255,0.95);
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 10px;
            display: none;
        }
        
        .hint-area.active {
            display: block;
        }
        
        .hint-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 10px;
            margin-bottom: 10px;
            font-size: 1rem;
        }
        
        .hint-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .number-btn {
            background: #f8f9fa;
            border: 2px solid #ddd;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .number-btn.selected {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }
        
        .send-hint-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .end-turn-btn {
            background: #ffc107;
            color: #333;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 10px;
        }
        
        /* Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© */
        .game-status {
            background: rgba(255,255,255,0.95);
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 10px;
            text-align: center;
            font-weight: bold;
        }
        
        .current-hint {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 10px;
            text-align: center;
        }
        
        /* Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© */
        .dropdown {
            position: relative;
            display: inline-block;
        }
        
        .dropdown-content {
            display: none;
            position: absolute;
            background-color: white;
            min-width: 300px;
            max-width: 400px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            z-index: 1000;
            border-radius: 10px;
            border: 2px solid #ddd;
            padding: 15px;
            top: 100%;
            right: 0;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .dropdown-content.show {
            display: block;
        }
        
        .dropdown-header {
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
            color: #333;
            text-align: center;
        }
        
        .dropdown-section {
            margin-bottom: 15px;
        }
        
        .dropdown-section-title {
            font-weight: bold;
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 8px;
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }
        
        .dropdown-item {
            padding: 8px 12px;
            margin: 5px 0;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 0.85rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #e9ecef;
        }
        
        .dropdown-item.red {
            background: #ffebee;
            border-color: #ffcdd2;
        }
        
        .dropdown-item.blue {
            background: #e3f2fd;
            border-color: #bbdefb;
        }
        
        .dropdown-item.no-team {
            background: #fff3e0;
            border-color: #ffcc02;
        }
        
        .dropdown-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            margin: 3px;
            transition: background 0.2s;
        }
        
        .dropdown-button:hover {
            background: #0056b3;
        }
        
        .dropdown-button.danger {
            background: #dc3545;
        }
        
        .dropdown-button.danger:hover {
            background: #c82333;
        }
        
        .dropdown-button.success {
            background: #28a745;
        }
        
        .dropdown-button.success:hover {
            background: #218838;
        }
        
        .dropdown-button.warning {
            background: #ffc107;
            color: #333;
        }
        
        .dropdown-button.warning:hover {
            background: #e0a800;
        }
        
        .dropdown-info {
            background: #e9ecef;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 0.8rem;
            line-height: 1.4;
        }
        
        .dropdown-link {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 0.8rem;
            word-break: break-all;
            border: 1px solid #ddd;
            font-family: monospace;
        }
        
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-left: 5px;
        }
        
        .status-indicator.online {
            background: #28a745;
        }
        
        .status-indicator.offline {
            background: #dc3545;
        }
        
        .player-role {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            background: #6c757d;
            color: white;
            margin-right: 5px;
        }
        
        .player-role.spy {
            background: #ffc107;
            color: #333;
        }
        
        .player-role.creator {
            background: #17a2b8;
        }
        
        /* ØªØµÙ…ÙŠÙ… Ù…ØªØ¬Ø§ÙˆØ¨ */
        @media (max-width: 768px) {
            .game-title {
                font-size: 2rem;
            }
            
            .cards-grid {
                gap: 5px;
            }
            
            .card {
                font-size: 0.7rem;
            }
            
            .bottom-area {
                height: 180px;
            }
            
            .toolbar {
                font-size: 0.8rem;
            }
            
            .dropdown-content {
                min-width: 280px;
                max-width: 90vw;
                left: 0;
                right: auto;
            }
        }
        
        .hidden {
            display: none !important;
        }
        
        /* ØªØ£Ø«ÙŠØ±Ø§Øª Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØ±ÙŠÙ‚ */
        .team-choice:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .team-choice:active {
            transform: translateY(-1px);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© -->
        <div class="start-screen" id="startScreen">
            <h1 class="game-title">Ù…Ø±Ø§Ø¨Ø·</h1>
            <input type="text" class="name-input" id="playerName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ" maxlength="20">
            <button class="start-btn" onclick="startGame()">Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©</button>
        </div>

        <!-- Ø´Ø§Ø´Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØ±ÙŠÙ‚ -->
        <div class="team-selection-screen" id="teamSelectionScreen" style="display: none;">
            <div class="start-screen">
                <h2 class="game-title" style="font-size: 2rem;">Ø§Ø®ØªØ± ÙØ±ÙŠÙ‚Ùƒ</h2>
                <div id="roomPlayersInfo" style="background: #f8f9fa; padding: 20px; border-radius: 15px; margin-bottom: 30px; max-width: 500px; width: 100%;"></div>
                
                <div style="display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; margin-bottom: 30px;">
                    <!-- Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø­Ù…Ø± -->
                    <div class="team-choice" style="background: #ffebee; border: 3px solid #f44336; border-radius: 15px; padding: 20px; min-width: 200px; cursor: pointer; transition: all 0.3s;" onclick="selectTeamAndRole('red', 'player')">
                        <div style="font-size: 1.5rem; margin-bottom: 10px;">ğŸ”´</div>
                        <div style="font-weight: bold; color: #d32f2f; margin-bottom: 5px;">Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø­Ù…Ø±</div>
                        <div style="font-size: 0.9rem; color: #666;">Ø§Ù†Ø¶Ù… ÙƒÙ„Ø§Ø¹Ø¨</div>
                        <div id="redTeamCount" style="font-size: 0.8rem; color: #999; margin-top: 5px;"></div>
                    </div>
                    
                    <!-- Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø²Ø±Ù‚ -->
                    <div class="team-choice" style="background: #e3f2fd; border: 3px solid #2196f3; border-radius: 15px; padding: 20px; min-width: 200px; cursor: pointer; transition: all 0.3s;" onclick="selectTeamAndRole('blue', 'player')">
                        <div style="font-size: 1.5rem; margin-bottom: 10px;">ğŸ”µ</div>
                        <div style="font-weight: bold; color: #1976d2; margin-bottom: 5px;">Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø²Ø±Ù‚</div>
                        <div style="font-size: 0.9rem; color: #666;">Ø§Ù†Ø¶Ù… ÙƒÙ„Ø§Ø¹Ø¨</div>
                        <div id="blueTeamCount" style="font-size: 0.8rem; color: #999; margin-top: 5px;"></div>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px; font-weight: bold; color: #666;">Ø£Ùˆ Ø§Ù†Ø¶Ù… ÙƒØ³Ø¨Ø§ÙŠ:</div>
                
                <div style="display: flex; gap: 15px; flex-wrap: wrap; justify-content: center; margin-bottom: 30px;">
                    <button class="start-btn" style="background: linear-gradient(45deg, #f44336, #d32f2f); padding: 10px 20px; font-size: 1rem;" onclick="selectTeamAndRole('red', 'spy')">Ø³Ø¨Ø§ÙŠ Ø£Ø­Ù…Ø±</button>
                    <button class="start-btn" style="background: linear-gradient(45deg, #2196f3, #1976d2); padding: 10px 20px; font-size: 1rem;" onclick="selectTeamAndRole('blue', 'spy')">Ø³Ø¨Ø§ÙŠ Ø£Ø²Ø±Ù‚</button>
                </div>
                
                <button class="start-btn" style="background: #6c757d; margin-top: 10px;" onclick="selectTeamAndRole(null, 'player')">Ø¯Ø®ÙˆÙ„ Ø¨Ø¯ÙˆÙ† ÙØ±ÙŠÙ‚</button>
            </div>
        </div>

        <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© -->
        <div class="game-screen" id="gameScreen">
            <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¯ÙˆØ§Øª -->
            <div class="toolbar">
                <div class="dropdown">
                    <div class="player-name-btn" id="playerNameBtn" onclick="togglePlayerDropdown()">
                        <span id="currentPlayerName"></span>
                    </div>
                    <div class="dropdown-content" id="playerDropdown">
                        <div class="dropdown-header">Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù„Ø§Ø¹Ø¨</div>
                        <div id="playerDropdownContent"></div>
                    </div>
                </div>
                
                <div class="dropdown">
                    <button class="toolbar-btn" onclick="toggleResetDropdown()">Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„</button>
                    <div class="dropdown-content" id="resetDropdown">
                        <div class="dropdown-header">Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ù„Ø¹Ø¨Ø©</div>
                        <div id="resetDropdownContent"></div>
                    </div>
                </div>
                
                <div class="dropdown">
                    <button class="toolbar-btn" onclick="toggleLinkDropdown()">Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ø±ÙˆÙ…</button>
                    <div class="dropdown-content" id="linkDropdown">
                        <div class="dropdown-header">Ø±Ø§Ø¨Ø· Ø§Ù„Ø±ÙˆÙ…</div>
                        <div id="linkDropdownContent"></div>
                    </div>
                </div>
                
                <button class="toolbar-btn secondary" onclick="leaveTeam()" id="leaveTeamBtn" style="display: none;">ØªØ±Ùƒ Ø§Ù„ÙØ±ÙŠÙ‚</button>
                
                <div class="dropdown">
                    <div class="toolbar-item" id="playersCount" onclick="togglePlayersDropdown()">
                        ğŸ‘¥ <span id="playerCountNum">0</span>
                    </div>
                    <div class="dropdown-content" id="playersDropdown">
                        <div class="dropdown-header">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†</div>
                        <div id="playersDropdownContent"></div>
                    </div>
                </div>
            </div>

            <!-- Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© -->
            <div class="game-status" id="gameStatus">
                ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†...
            </div>

            <!-- Ø§Ù„ØªÙ„Ù…ÙŠØ­ Ø§Ù„Ø­Ø§Ù„ÙŠ -->
            <div class="current-hint hidden" id="currentHint"></div>

            <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ØªÙ„Ù…ÙŠØ­ -->
            <div class="hint-area" id="hintArea">
                <input type="text" class="hint-input" id="hintInput" placeholder="Ø§ÙƒØªØ¨ ØªÙ„Ù…ÙŠØ­Ùƒ Ù‡Ù†Ø§...">
                <div class="hint-controls">
                    <span>Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙ„Ù…Ø§Øª:</span>
                    <div class="number-btn" onclick="selectNumber(1)">1</div>
                    <div class="number-btn" onclick="selectNumber(2)">2</div>
                    <div class="number-btn" onclick="selectNumber(3)">3</div>
                    <div class="number-btn" onclick="selectNumber(4)">4</div>
                    <div class="number-btn" onclick="selectNumber(5)">5</div>
                    <div class="number-btn" onclick="selectNumber(6)">6</div>
                    <div class="number-btn" onclick="selectNumber(7)">7</div>
                    <div class="number-btn" onclick="selectNumber(8)">8</div>
                    <button class="send-hint-btn" onclick="sendHint()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ„Ù…ÙŠØ­</button>
                </div>
                <button class="end-turn-btn" onclick="endTurn()">Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¯ÙˆØ±</button>
            </div>

            <!-- Ø´Ø¨ÙƒØ© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª -->
            <div class="cards-grid" id="cardsGrid"></div>

            <!-- Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø³ÙÙ„ÙŠØ© -->
            <div class="bottom-area">
                <!-- Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø­Ù…Ø± -->
                <div class="team-panel red">
                    <div class="team-title" style="color: #dc3545;">Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø­Ù…Ø±</div>
                    <div class="team-section">
                        <div class="section-title">Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†:</div>
                        <div id="redPlayers"></div>
                    </div>
                    <div class="team-section">
                        <div class="section-title">Ø§Ù„Ø³Ø¨Ø§ÙŠ:</div>
                        <div id="redSpies"></div>
                    </div>
                </div>

                <!-- Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø¨Ø¯ÙˆÙ† ÙØ±ÙŠÙ‚ ÙˆØ³Ø¬Ù„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« -->
                <div class="log-panel">
                    <div class="team-section" id="noTeamSection" style="margin-bottom: 15px; display: none;">
                        <div class="section-title" style="color: #666; text-align: center;">Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø¨Ø¯ÙˆÙ† ÙØ±ÙŠÙ‚:</div>
                        <div id="noTeamPlayers"></div>
                    </div>
                    <div class="log-title">Ø³Ø¬Ù„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«</div>
                    <div id="gameLog"></div>
                </div>

                <!-- Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø²Ø±Ù‚ -->
                <div class="team-panel blue">
                    <div class="team-title" style="color: #007bff;">Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø²Ø±Ù‚</div>
                    <div class="team-section">
                        <div class="section-title">Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†:</div>
                        <div id="bluePlayers"></div>
                    </div>
                    <div class="team-section">
                        <div class="section-title">Ø§Ù„Ø³Ø¨Ø§ÙŠ:</div>
                        <div id="blueSpies"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Ø¥Ø¹Ø¯Ø§Ø¯ Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBLyoIoXp2aJCnhFqIFufMVBz0fzCS-FYY",
            authDomain: "game-303eb.firebaseapp.com",
            databaseURL: "https://game-303eb-default-rtdb.firebaseio.com",
            projectId: "game-303eb",
            storageBucket: "game-303eb.firebasestorage.app",
            messagingSenderId: "22261863844",
            appId: "1:22261863844:web:66f8541079b9025ec69d31",
            measurementId: "G-RKN2F3HVHS"
        };

        // Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø©
        let database;
        let isFirebaseReady = false;
        let connectionAttempts = 0;
        const maxConnectionAttempts = 3;

        // Ø¥Ø¸Ù‡Ø§Ø± Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
        function showConnectionStatus(message, isError = false) {
            const startBtn = document.querySelector('.start-btn');
            if (startBtn) {
                startBtn.textContent = message;
                startBtn.style.background = isError ? '#dc3545' : '#28a745';
                if (!isError) {
                    setTimeout(() => {
                        startBtn.textContent = 'Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©';
                        startBtn.style.background = '';
                    }, 2000);
                }
            }
        }

        // ØªÙ‡ÙŠØ¦Ø© Firebase Ù…Ø¹ ØªØ´Ø®ÙŠØµ Ù…ÙØµÙ„
        function initializeFirebase() {
            console.log('ğŸ”„ Ø¨Ø¯Ø¡ ØªÙ‡ÙŠØ¦Ø© Firebase...');
            showConnectionStatus('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...');
            
            try {
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Firebase
                if (typeof firebase === 'undefined') {
                    throw new Error('Firebase SDK ØºÙŠØ± Ù…Ø­Ù…Ù„');
                }

                // ØªÙ‡ÙŠØ¦Ø© Firebase
                if (!firebase.apps.length) {
                    console.log('ğŸ“± ØªÙ‡ÙŠØ¦Ø© ØªØ·Ø¨ÙŠÙ‚ Firebase...');
                    firebase.initializeApp(firebaseConfig);
                } else {
                    console.log('ğŸ“± Firebase Ù…Ù‡ÙŠØ£ Ù…Ø³Ø¨Ù‚Ø§Ù‹');
                }

                // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø±Ø¬Ø¹ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                database = firebase.database();
                console.log('ğŸ’¾ ØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø±Ø¬Ø¹ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');

                // Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
                console.log('ğŸ” Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„...');
                
                // Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ø³ÙŠØ· Ù„Ù„ÙƒØªØ§Ø¨Ø© ÙˆØ§Ù„Ù‚Ø±Ø§Ø¡Ø©
                const testRef = database.ref('test');
                const testData = { timestamp: Date.now(), test: true };
                
                testRef.set(testData).then(() => {
                    console.log('âœ… Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙƒØªØ§Ø¨Ø© Ù†Ø¬Ø­');
                    
                    return testRef.once('value');
                }).then((snapshot) => {
                    console.log('âœ… Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ù†Ø¬Ø­:', snapshot.val());
                    
                    // Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ©
                    testRef.remove();
                    
                    isFirebaseReady = true;
                    showConnectionStatus('Ù…ØªØµÙ„ Ø¨Ù†Ø¬Ø§Ø­!');
                    console.log('ğŸ‰ Firebase Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…!');
                    
                    // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø§ØªØµØ§Ù„
                    setupConnectionMonitoring();
                    
                }).catch((error) => {
                    console.error('âŒ ÙØ´Ù„ Ø§Ø®ØªØ¨Ø§Ø± Firebase:', error);
                    handleConnectionError(error);
                });

            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Firebase:', error);
                handleConnectionError(error);
            }
        }

        // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø§ØªØµØ§Ù„
        function setupConnectionMonitoring() {
            const connectedRef = database.ref('.info/connected');
            connectedRef.on('value', (snapshot) => {
                if (snapshot.val() === true) {
                    console.log('ğŸŸ¢ Ù…ØªØµÙ„ Ø¨Ù€ Firebase');
                    isFirebaseReady = true;
                } else {
                    console.log('ğŸ”´ Ù…Ù†Ù‚Ø·Ø¹ Ø¹Ù† Firebase');
                    isFirebaseReady = false;
                }
            });
        }

        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„
        function handleConnectionError(error) {
            console.error('ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø·Ø£:', {
                code: error.code,
                message: error.message,
                stack: error.stack
            });

            let errorMessage = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„';
            
            if (error.code === 'PERMISSION_DENIED') {
                errorMessage = 'Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ©';
                console.error('ğŸš« Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª - ØªØ­Ù‚Ù‚ Ù…Ù† Ù‚ÙˆØ§Ø¹Ø¯ Firebase');
            } else if (error.code === 'NETWORK_ERROR' || error.message.includes('network')) {
                errorMessage = 'Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø´Ø¨ÙƒØ©';
                console.error('ğŸŒ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø´Ø¨ÙƒØ©');
            } else if (error.message.includes('Firebase SDK')) {
                errorMessage = 'Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„';
                console.error('ğŸ“¦ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ ØªØ­Ù…ÙŠÙ„ Firebase SDK');
            }

            showConnectionStatus(errorMessage, true);
            isFirebaseReady = false;

            // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„
            if (connectionAttempts < maxConnectionAttempts) {
                connectionAttempts++;
                console.log(`ğŸ”„ Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„ ${connectionAttempts}/${maxConnectionAttempts}`);
                setTimeout(() => {
                    initializeFirebase();
                }, 3000 * connectionAttempts);
            } else {
                console.error('âŒ ÙØ´Ù„ ÙÙŠ Ø¬Ù…ÙŠØ¹ Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„');
                showConnectionStatus('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹', true);
            }
        }

        // Ø¨Ø¯Ø¡ ØªÙ‡ÙŠØ¦Ø© Firebase Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸ“„ ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©ØŒ Ø¨Ø¯Ø¡ ØªÙ‡ÙŠØ¦Ø© Firebase...');
            initializeFirebase();
        });

        // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø©
        let currentPlayer = null;
        let roomId = null;
        let gameState = null;
        let selectedNumber = 1;

        // ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø©
        const gameWords = [
            'Ø´Ù…Ø³', 'Ù‚Ù…Ø±', 'Ù†Ø¬Ù…', 'Ø¨Ø­Ø±', 'Ø¬Ø¨Ù„', 'Ø´Ø¬Ø±', 'Ø²Ù‡Ø±', 'Ø·ÙŠØ±', 'Ø³Ù…Ùƒ', 'Ø£Ø³Ø¯',
            'ÙÙŠÙ„', 'Ø­ØµØ§Ù†', 'ÙƒØªØ§Ø¨', 'Ù‚Ù„Ù…', 'ÙˆØ±Ù‚', 'Ø¨Ø§Ø¨', 'Ù†Ø§ÙØ°Ø©', 'ÙƒØ±Ø³ÙŠ', 'Ø·Ø§ÙˆÙ„Ø©', 'Ø³Ø±ÙŠØ±',
            'Ù…Ø§Ø¡', 'Ù†Ø§Ø±', 'Ù‡ÙˆØ§Ø¡', 'ØªØ±Ø§Ø¨', 'Ø°Ù‡Ø¨', 'ÙØ¶Ø©', 'Ø­Ø¯ÙŠØ¯', 'Ø®Ø´Ø¨', 'Ø­Ø¬Ø±', 'Ø²Ø¬Ø§Ø¬',
            'Ø³ÙŠØ§Ø±Ø©', 'Ø·Ø§Ø¦Ø±Ø©', 'Ù‚Ø·Ø§Ø±', 'Ø³ÙÙŠÙ†Ø©', 'Ø¯Ø±Ø§Ø¬Ø©', 'Ø­Ø§Ø³ÙˆØ¨', 'Ù‡Ø§ØªÙ', 'ØªÙ„ÙØ§Ø²', 'Ø±Ø§Ø¯ÙŠÙˆ', 'Ø³Ø§Ø¹Ø©',
            'Ù…Ø¯Ø±Ø³Ø©', 'Ø¨ÙŠØª', 'Ù…Ø³ØªØ´ÙÙ‰', 'Ù…Ø·Ø¹Ù…', 'Ø­Ø¯ÙŠÙ‚Ø©', 'Ø´Ø§Ø±Ø¹', 'Ù…Ø¯ÙŠÙ†Ø©', 'Ù‚Ø±ÙŠØ©', 'ØµØ­Ø±Ø§Ø¡', 'ØºØ§Ø¨Ø©'
        ];

        // Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©
        function startGame() {
            const name = document.getElementById('playerName').value.trim();
            if (!name) {
                alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù…Ùƒ');
                return;
            }

            console.log('ğŸ® Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©...');
            console.log('ğŸ“Š Ø­Ø§Ù„Ø© Firebase:', { isFirebaseReady, database: !!database });

            const startBtn = document.querySelector('.start-btn');
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¬Ø§Ù‡Ø²ÙŠØ© Firebase
            if (!isFirebaseReady || !database) {
                console.log('â³ Firebase ØºÙŠØ± Ø¬Ø§Ù‡Ø²ØŒ Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„...');
                showConnectionStatus('Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„...');
                
                // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¹Ø§Ø¯Ø© ØªÙ‡ÙŠØ¦Ø© Firebase
                initializeFirebase();
                
                // Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„
                let attempts = 0;
                const maxAttempts = 15;
                const checkConnection = setInterval(() => {
                    attempts++;
                    console.log(`ğŸ”„ ÙØ­Øµ Ø§Ù„Ø§ØªØµØ§Ù„ ${attempts}/${maxAttempts}`);
                    
                    if (isFirebaseReady && database) {
                        clearInterval(checkConnection);
                        console.log('âœ… Firebase Ø¬Ø§Ù‡Ø²ØŒ Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©...');
                        proceedWithGame(name);
                    } else if (attempts >= maxAttempts) {
                        clearInterval(checkConnection);
                        console.error('âŒ Ø§Ù†ØªÙ‡Øª Ù…Ù‡Ù„Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±');
                        showConnectionStatus('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„', true);
                        
                        // Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
                        const errorDetails = `
                        Ø­Ø¯Ø«Øª Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„:
                        
                        ğŸ” ØªØ´Ø®ÙŠØµ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©:
                        - Firebase SDK: ${typeof firebase !== 'undefined' ? 'âœ… Ù…Ø­Ù…Ù„' : 'âŒ ØºÙŠØ± Ù…Ø­Ù…Ù„'}
                        - Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${database ? 'âœ… Ù…ØªØ§Ø­Ø©' : 'âŒ ØºÙŠØ± Ù…ØªØ§Ø­Ø©'}
                        - Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„: ${isFirebaseReady ? 'âœ… Ù…ØªØµÙ„' : 'âŒ ØºÙŠØ± Ù…ØªØµÙ„'}
                        
                        ğŸ’¡ Ø§Ù„Ø­Ù„ÙˆÙ„ Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø©:
                        1. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª
                        2. Ø£Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
                        3. Ø¬Ø±Ø¨ Ù…ØªØµÙØ­ Ø¢Ø®Ø±
                        4. ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Firebase Ù…ÙØ¹Ø¯ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­
                        `;
                        
                        alert(errorDetails);
                    }
                }, 1000);
                
                return;
            }

            console.log('âœ… Firebase Ø¬Ø§Ù‡Ø²ØŒ Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø© Ù…Ø¨Ø§Ø´Ø±Ø©...');
            proceedWithGame(name);
        }

        // Ù…ØªØ§Ø¨Ø¹Ø© Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø© Ø¨Ø¹Ø¯ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„
        function proceedWithGame(name) {
            // Ø­ÙØ¸ Ø§Ù„Ø§Ø³Ù… ÙÙŠ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ
            localStorage.setItem('playerName', name);
            
            currentPlayer = {
                id: generateId(),
                name: name,
                online: true,
                team: null,
                role: 'player'
            };

            // Ø¥Ù†Ø´Ø§Ø¡ Ø£Ùˆ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„ØºØ±ÙØ©
            const roomFromUrl = getRoomIdFromUrl();
            
            if (roomFromUrl) {
                // Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„ØºØ±ÙØ© Ù…ÙˆØ¬ÙˆØ¯Ø© - Ø¹Ø±Ø¶ Ø´Ø§Ø´Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØ±ÙŠÙ‚
                roomId = roomFromUrl;
                showTeamSelectionScreen();
            } else {
                // Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© Ø¬Ø¯ÙŠØ¯Ø© - Ø§Ù„Ø°Ù‡Ø§Ø¨ Ù…Ø¨Ø§Ø´Ø±Ø© Ù„Ù„Ø¹Ø¨Ø©
                roomId = generateRoomId();
                joinRoom();
            }
            
            console.log('Starting game with room ID:', roomId);
            console.log('Player:', currentPlayer);
            console.log('Database ready:', !!database);
            console.log('Firebase ready:', isFirebaseReady);
        }

        // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¹Ø±Ù ÙØ±ÙŠØ¯
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¹Ø±Ù Ø§Ù„ØºØ±ÙØ©
        function generateRoomId() {
            return Math.random().toString(36).substr(2, 8);
        }

        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ø±Ù Ø§Ù„ØºØ±ÙØ© Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·
        function getRoomIdFromUrl() {
            const params = new URLSearchParams(window.location.search);
            return params.get('room');
        }

        // Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„ØºØ±ÙØ©
        function joinRoom() {
            console.log('Joining room:', roomId);
            
            if (!database) {
                console.error('Database not initialized');
                alert('Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ø¬Ø§Ù‡Ø²Ø©ØŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©');
                return;
            }
            
            // Ø¥Ø¶Ø§ÙØ© timeout Ù„Ù„Ø¹Ù…Ù„ÙŠØ©
            const roomRef = database.ref(`rooms/${roomId}`);
            
            // ØªØ¹ÙŠÙŠÙ† timeout
            const timeoutId = setTimeout(() => {
                console.error('Room join timeout');
                alert('Ø§Ù†ØªÙ‡Øª Ù…Ù‡Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
            }, 15000);
            
            roomRef.once('value', (snapshot) => {
                clearTimeout(timeoutId);
                console.log('Room snapshot exists:', snapshot.exists());
                console.log('Room data:', snapshot.val());
                
                if (!snapshot.exists()) {
                    // Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© Ø¬Ø¯ÙŠØ¯Ø©
                    console.log('Creating new room');
                    createNewRoom();
                } else {
                    // Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„ØºØ±ÙØ© Ù…ÙˆØ¬ÙˆØ¯Ø©
                    console.log('Joining existing room');
                    joinExistingRoom();
                }
            }).catch((error) => {
                clearTimeout(timeoutId);
                console.error('Error joining room:', error);
                console.error('Error details:', {
                    code: error.code,
                    message: error.message,
                    details: error.details
                });
                
                // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ´Ø®ÙŠØµ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©
                if (error.code === 'PERMISSION_DENIED') {
                    alert('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase.');
                } else if (error.code === 'NETWORK_ERROR') {
                    alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø´Ø¨ÙƒØ©. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.');
                } else {
                    alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + error.message);
                }
            });
        }

        // Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© Ø¬Ø¯ÙŠØ¯Ø©
        function createNewRoom() {
            console.log('Creating new room with ID:', roomId);
            
            try {
                const cards = generateCards();
                console.log('Cards generated successfully:', cards.length);
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª
                const validCards = cards.every(card => 
                    card && 
                    typeof card.id === 'number' && 
                    typeof card.word === 'string' && 
                    typeof card.color === 'string' && 
                    typeof card.revealed === 'boolean' &&
                    card.votes !== undefined
                );
                
                if (!validCards) {
                    throw new Error('Invalid cards generated');
                }
                
                const newGameState = {
                    players: {},
                    cards: cards,
                    currentTeam: 'red',
                    phase: 'waiting',
                    hint: null,
                    remainingGuesses: 0,
                    log: {},
                    redScore: 8,
                    blueScore: 7,
                    winner: null,
                    creator: currentPlayer.id,
                    allowTeamChange: true
                };

                newGameState.players[currentPlayer.id] = {
                    id: currentPlayer.id,
                    name: currentPlayer.name,
                    online: true,
                    team: null,
                    role: 'player'
                };
                
                console.log('New game state prepared:', newGameState);

                database.ref(`rooms/${roomId}`).set(newGameState).then(() => {
                    console.log('Room created successfully');
                    setupGameListeners();
                    showGameScreen();
                    updateUrl();
                }).catch((error) => {
                    console.error('Error creating room:', error);
                    alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØºØ±ÙØ©: ' + error.message);
                });
                
            } catch (error) {
                console.error('Error in createNewRoom:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù„Ø¹Ø¨Ø©: ' + error.message);
            }
        }

        // Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„ØºØ±ÙØ© Ù…ÙˆØ¬ÙˆØ¯Ø©
        function joinExistingRoom() {
            console.log('Joining existing room');
            database.ref(`rooms/${roomId}/players/${currentPlayer.id}`).set(currentPlayer).then(() => {
                console.log('Player added to existing room');
                
                // Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø³Ø¬Ù„
                const teamText = currentPlayer.team ? 
                    (currentPlayer.team === 'red' ? 'Ø§Ù„Ø£Ø­Ù…Ø±' : 'Ø§Ù„Ø£Ø²Ø±Ù‚') : 
                    'Ø¨Ø¯ÙˆÙ† ÙØ±ÙŠÙ‚';
                const roleText = currentPlayer.role === 'spy' ? 'Ø³Ø¨Ø§ÙŠ' : 'Ù„Ø§Ø¹Ø¨';
                
                if (currentPlayer.team) {
                    addToLog(`${currentPlayer.name} Ø§Ù†Ø¶Ù… Ù„Ù„ÙØ±ÙŠÙ‚ ${teamText} ÙƒÙ€ ${roleText}`);
                } else {
                    addToLog(`${currentPlayer.name} Ø§Ù†Ø¶Ù… Ù„Ù„Ø±ÙˆÙ…`);
                }
                
                setupGameListeners();
                showGameScreen();
                updateUrl();
            }).catch((error) => {
                console.error('Error joining existing room:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„ØºØ±ÙØ©');
            });
        }

        // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª
        function generateCards() {
            const cards = [];
            
            // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ ÙƒÙ„Ù…Ø§Øª ÙƒØ§ÙÙŠØ©
            const availableWords = [...gameWords];
            while (availableWords.length < 25) {
                availableWords.push(`ÙƒÙ„Ù…Ø©${availableWords.length + 1}`);
            }
            const shuffledWords = availableWords.slice(0, 25).sort(() => Math.random() - 0.5);
            
            // ØªØ­Ø¯ÙŠØ¯ Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª (8 Ø£Ø­Ù…Ø±ØŒ 7 Ø£Ø²Ø±Ù‚ØŒ 1 Ø£Ø³ÙˆØ¯ØŒ 9 Ù…Ø­Ø§ÙŠØ¯)
            const colors = [
                'red', 'red', 'red', 'red', 'red', 'red', 'red', 'red',
                'blue', 'blue', 'blue', 'blue', 'blue', 'blue', 'blue',
                'black',
                'neutral', 'neutral', 'neutral', 'neutral', 'neutral', 'neutral', 'neutral', 'neutral', 'neutral'
            ];
            
            // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ù„Ø¯ÙŠÙ†Ø§ 25 Ù„ÙˆÙ† Ø¨Ø§Ù„Ø¶Ø¨Ø·
            while (colors.length < 25) {
                colors.push('neutral');
            }
            
            const shuffledColors = colors.slice(0, 25).sort(() => Math.random() - 0.5);

            for (let i = 0; i < 25; i++) {
                cards.push({
                    id: i,
                    word: shuffledWords[i] || `ÙƒÙ„Ù…Ø©${i + 1}`,
                    color: shuffledColors[i] || 'neutral',
                    revealed: false,
                    votes: {}
                });
            }

            console.log('Generated cards:', cards.length, 'cards');
            console.log('Card colors:', cards.map(c => c.color));
            
            return cards;
        }

        // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø³ØªÙ…Ø¹ÙŠ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
        function setupGameListeners() {
            database.ref(`rooms/${roomId}`).on('value', (snapshot) => {
                if (snapshot.exists()) {
                    gameState = snapshot.val();
                    updateGameDisplay();
                }
            });

            // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
            database.ref(`rooms/${roomId}/players/${currentPlayer.id}/online`).set(true);
            database.ref(`rooms/${roomId}/players/${currentPlayer.id}/online`).onDisconnect().set(false);
        }

        // Ø¹Ø±Ø¶ Ø´Ø§Ø´Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØ±ÙŠÙ‚
        function showTeamSelectionScreen() {
            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('teamSelectionScreen').style.display = 'flex';
            
            // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø³ØªÙ…Ø¹ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØºØ±ÙØ©
            database.ref(`rooms/${roomId}`).once('value', (snapshot) => {
                if (snapshot.exists()) {
                    const roomData = snapshot.val();
                    updateTeamSelectionInfo(roomData);
                } else {
                    // Ø§Ù„ØºØ±ÙØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©
                    alert('Ø§Ù„ØºØ±ÙØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© Ø£Ùˆ Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØªÙ‡Ø§');
                    document.getElementById('teamSelectionScreen').style.display = 'none';
                    document.getElementById('startScreen').style.display = 'flex';
                }
            });
        }

        // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØ±ÙŠÙ‚
        function updateTeamSelectionInfo(roomData) {
            const players = Object.values(roomData.players || {});
            const redPlayers = players.filter(p => p.team === 'red');
            const bluePlayers = players.filter(p => p.team === 'blue');
            const noTeamPlayers = players.filter(p => !p.team);
            
            // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØºØ±ÙØ©
            const roomInfo = document.getElementById('roomPlayersInfo');
            roomInfo.innerHTML = `
                <div style="font-weight: bold; margin-bottom: 15px; color: #333;">
                    ğŸ  Ø§Ù„ØºØ±ÙØ©: ${roomId} | ğŸ‘¥ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†: ${players.length}
                </div>
                <div style="display: flex; gap: 20px; justify-content: center; flex-wrap: wrap;">
                    <div style="text-align: center;">
                        <div style="color: #d32f2f; font-weight: bold;">ğŸ”´ Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø­Ù…Ø±</div>
                        <div style="font-size: 0.9rem; color: #666;">
                            ${redPlayers.filter(p => p.role === 'player').length} Ù„Ø§Ø¹Ø¨ÙŠÙ† | 
                            ${redPlayers.filter(p => p.role === 'spy').length} Ø³Ø¨Ø§ÙŠ
                        </div>
                        ${redPlayers.length > 0 ? '<div style="font-size: 0.8rem; margin-top: 5px;">' + redPlayers.map(p => p.name).join(', ') + '</div>' : ''}
                    </div>
                    <div style="text-align: center;">
                        <div style="color: #1976d2; font-weight: bold;">ğŸ”µ Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø²Ø±Ù‚</div>
                        <div style="font-size: 0.9rem; color: #666;">
                            ${bluePlayers.filter(p => p.role === 'player').length} Ù„Ø§Ø¹Ø¨ÙŠÙ† | 
                            ${bluePlayers.filter(p => p.role === 'spy').length} Ø³Ø¨Ø§ÙŠ
                        </div>
                        ${bluePlayers.length > 0 ? '<div style="font-size: 0.8rem; margin-top: 5px;">' + bluePlayers.map(p => p.name).join(', ') + '</div>' : ''}
                    </div>
                </div>
                ${noTeamPlayers.length > 0 ? `
                    <div style="margin-top: 15px; text-align: center;">
                        <div style="color: #666; font-weight: bold;">âšª Ø¨Ø¯ÙˆÙ† ÙØ±ÙŠÙ‚</div>
                        <div style="font-size: 0.8rem; margin-top: 5px;">${noTeamPlayers.map(p => p.name).join(', ')}</div>
                    </div>
                ` : ''}
            `;
            
            // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙØ±Ù‚
            document.getElementById('redTeamCount').textContent = `${redPlayers.length} Ù„Ø§Ø¹Ø¨ÙŠÙ†`;
            document.getElementById('blueTeamCount').textContent = `${bluePlayers.length} Ù„Ø§Ø¹Ø¨ÙŠÙ†`;
        }

        // Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØ±ÙŠÙ‚ ÙˆØ§Ù„Ø¯ÙˆØ±
        function selectTeamAndRole(team, role) {
            currentPlayer.team = team;
            currentPlayer.role = role;
            
            // Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„ØºØ±ÙØ© Ù…Ø¹ Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ù…Ø­Ø¯Ø¯
            joinExistingRoom();
        }

        // Ø¹Ø±Ø¶ Ø´Ø§Ø´Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©
        function showGameScreen() {
            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('teamSelectionScreen').style.display = 'none';
            document.getElementById('gameScreen').style.display = 'flex';
            document.getElementById('currentPlayerName').textContent = currentPlayer.name;
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø§Ø¨Ø·
        function updateUrl() {
            const newUrl = `${window.location.origin}${window.location.pathname}?room=${roomId}`;
            window.history.replaceState({}, '', newUrl);
        }

        // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ù„Ø¹Ø¨Ø©
        function updateGameDisplay() {
            if (!gameState) return;

            updatePlayersDisplay();
            updateCardsDisplay();
            updateGameStatus();
            updateLog();
            updateHintArea();
            updateLeaveTeamButton();
        }

        // ØªØ­Ø¯ÙŠØ« Ø²Ø± ØªØ±Ùƒ Ø§Ù„ÙØ±ÙŠÙ‚
        function updateLeaveTeamButton() {
            const leaveBtn = document.getElementById('leaveTeamBtn');
            if (currentPlayer.team && gameState.allowTeamChange !== false) {
                leaveBtn.style.display = 'inline-block';
            } else {
                leaveBtn.style.display = 'none';
            }
        }

        // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†
        function updatePlayersDisplay() {
            const players = Object.values(gameState.players);
            const redPlayers = players.filter(p => p.team === 'red' && p.role === 'player');
            const redSpies = players.filter(p => p.team === 'red' && p.role === 'spy');
            const bluePlayers = players.filter(p => p.team === 'blue' && p.role === 'player');
            const blueSpies = players.filter(p => p.team === 'blue' && p.role === 'spy');
            const noTeamPlayers = players.filter(p => !p.team);

            document.getElementById('playerCountNum').textContent = players.length;
            
            updateTeamDisplay('redPlayers', redPlayers);
            updateTeamDisplay('redSpies', redSpies);
            updateTeamDisplay('bluePlayers', bluePlayers);
            updateTeamDisplay('blueSpies', blueSpies);
            updateNoTeamDisplay(noTeamPlayers);
        }

        // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„ÙØ±ÙŠÙ‚
        function updateTeamDisplay(elementId, players) {
            const container = document.getElementById(elementId);
            container.innerHTML = '';

            players.forEach(player => {
                const playerDiv = document.createElement('div');
                playerDiv.className = `player-item ${player.online ? '' : 'offline'}`;
                
                let content = player.name;
                if (gameState.creator === currentPlayer.id && player.id !== currentPlayer.id) {
                    content += ` <button class="kick-btn" onclick="kickPlayer('${player.id}')">Ø·Ø±Ø¯</button>`;
                }
                
                playerDiv.innerHTML = content;
                container.appendChild(playerDiv);
            });

            // Ø¥Ø¶Ø§ÙØ© Ø²Ø± Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… ÙÙ‚Ø· Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ø§Ù„Ù„Ø§Ø¹Ø¨ ÙÙŠ Ø£ÙŠ ÙØ±ÙŠÙ‚ ÙˆÙƒØ§Ù† Ø§Ù„ØªØºÙŠÙŠØ± Ù…Ø³Ù…ÙˆØ­
            if (!currentPlayer.team && (gameState.allowTeamChange !== false) && players.length < 4) {
                const joinBtn = document.createElement('div');
                joinBtn.className = 'player-item';
                joinBtn.style.cursor = 'pointer';
                joinBtn.style.background = '#e3f2fd';
                joinBtn.style.border = '2px dashed #007bff';
                joinBtn.textContent = 'Ø§Ù†Ø¶Ù… ÙƒÙ€ ' + (elementId.includes('Spies') ? 'Ø³Ø¨Ø§ÙŠ' : 'Ù„Ø§Ø¹Ø¨');
                joinBtn.onclick = () => joinTeam(elementId);
                container.appendChild(joinBtn);
            }
        }

        // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø¨Ø¯ÙˆÙ† ÙØ±ÙŠÙ‚
        function updateNoTeamDisplay(players) {
            const container = document.getElementById('noTeamPlayers');
            const section = document.getElementById('noTeamSection');
            
            container.innerHTML = '';
            
            if (players.length > 0) {
                section.style.display = 'block';
                players.forEach(player => {
                    const playerDiv = document.createElement('div');
                    playerDiv.className = `player-item ${player.online ? '' : 'offline'}`;
                    playerDiv.style.background = '#fff3cd';
                    playerDiv.style.border = '1px solid #ffeaa7';
                    
                    let content = player.name;
                    if (gameState.creator === currentPlayer.id && player.id !== currentPlayer.id) {
                        content += ` <button class="kick-btn" onclick="kickPlayer('${player.id}')">Ø·Ø±Ø¯</button>`;
                    }
                    
                    playerDiv.innerHTML = content;
                    container.appendChild(playerDiv);
                });
            } else {
                section.style.display = 'none';
            }
        }

        // Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„ÙØ±ÙŠÙ‚
        function joinTeam(elementId) {
            const team = elementId.includes('red') ? 'red' : 'blue';
            const role = elementId.includes('Spies') ? 'spy' : 'player';

            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù„Ø§Ø¹Ø¨ ÙÙŠ ÙØ±ÙŠÙ‚ Ø¢Ø®Ø±ØŒ Ø§ØªØ±ÙƒÙ‡ Ø£ÙˆÙ„Ø§Ù‹
            if (currentPlayer.team && currentPlayer.team !== team) {
                addToLog(`${currentPlayer.name} Ø§Ù†ØªÙ‚Ù„ Ù…Ù† Ø§Ù„ÙØ±ÙŠÙ‚ ${currentPlayer.team === 'red' ? 'Ø§Ù„Ø£Ø­Ù…Ø±' : 'Ø§Ù„Ø£Ø²Ø±Ù‚'} Ø¥Ù„Ù‰ Ø§Ù„ÙØ±ÙŠÙ‚ ${team === 'red' ? 'Ø§Ù„Ø£Ø­Ù…Ø±' : 'Ø§Ù„Ø£Ø²Ø±Ù‚'}`);
            } else if (!currentPlayer.team) {
                addToLog(`${currentPlayer.name} Ø§Ù†Ø¶Ù… Ù„Ù„ÙØ±ÙŠÙ‚ ${team === 'red' ? 'Ø§Ù„Ø£Ø­Ù…Ø±' : 'Ø§Ù„Ø£Ø²Ø±Ù‚'} ÙƒÙ€ ${role === 'spy' ? 'Ø³Ø¨Ø§ÙŠ' : 'Ù„Ø§Ø¹Ø¨'}`);
            }

            currentPlayer.team = team;
            currentPlayer.role = role;

            database.ref(`rooms/${roomId}/players/${currentPlayer.id}`).update({
                team: team,
                role: role
            });
        }

        // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª
        function updateCardsDisplay() {
            const grid = document.getElementById('cardsGrid');
            grid.innerHTML = '';

            gameState.cards.forEach(card => {
                const cardDiv = document.createElement('div');
                cardDiv.className = 'card';
                cardDiv.id = `card-${card.id}`;

                // ØªØ­Ø¯ÙŠØ¯ Ù„ÙˆÙ† Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
                if (card.revealed) {
                    cardDiv.classList.add('revealed', card.color);
                } else if (currentPlayer.role === 'spy') {
                    cardDiv.style.background = getCardColor(card.color);
                }

                // Ø¥Ø¶Ø§ÙØ© Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø§Ù„ØªØµÙˆÙŠØª
                if (gameState.phase === 'guessing' && currentPlayer.team === gameState.currentTeam && currentPlayer.role === 'player') {
                    cardDiv.classList.add('can-select');
                }

                // Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
                let cardContent = `<div>${card.word}</div>`;
                
                // Ø¹Ø±Ø¶ Ø§Ù„Ø£ØµÙˆØ§Øª
                if (Object.keys(card.votes).length > 0) {
                    cardContent += '<div class="voters">';
                    Object.values(card.votes).forEach(vote => {
                        const voter = gameState.players[vote.playerId];
                        if (voter) {
                            cardContent += `<span class="voter ${voter.team}">${voter.name}</span>`;
                        }
                    });
                    cardContent += '</div>';
                }

                cardDiv.innerHTML = cardContent;

                // Ø¥Ø¶Ø§ÙØ© Ø²Ø± Ø§Ù„ÙŠØ¯
                if (cardDiv.classList.contains('can-select')) {
                    const handBtn = document.createElement('button');
                    handBtn.className = 'hand-btn';
                    handBtn.innerHTML = 'âœ‹';
                    handBtn.onclick = (e) => {
                        e.stopPropagation();
                        selectCard(card.id);
                    };
                    cardDiv.appendChild(handBtn);
                }

                // Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø« Ø§Ù„Ù†Ù‚Ø± Ù„Ù„ØªØµÙˆÙŠØª
                cardDiv.onclick = () => voteForCard(card.id);

                grid.appendChild(cardDiv);
            });
        }

        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù„ÙˆÙ† Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
        function getCardColor(color) {
            switch (color) {
                case 'red': return '#dc3545';
                case 'blue': return '#007bff';
                case 'black': return '#343a40';
                case 'neutral': return '#6c757d';
                default: return '#f5f5dc';
            }
        }

        // Ø§Ù„ØªØµÙˆÙŠØª Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
        function voteForCard(cardId) {
            if (gameState.phase !== 'guessing' || currentPlayer.team !== gameState.currentTeam || currentPlayer.role !== 'player') {
                return;
            }

            const card = gameState.cards[cardId];
            if (card.revealed) return;

            const voteRef = database.ref(`rooms/${roomId}/cards/${cardId}/votes/${currentPlayer.id}`);
            
            if (card.votes[currentPlayer.id]) {
                // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØµÙˆÙŠØª
                voteRef.remove();
            } else {
                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØµÙˆÙŠØª
                voteRef.set({
                    playerId: currentPlayer.id,
                    timestamp: Date.now()
                });
            }
        }

        // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹
        function selectCard(cardId) {
            if (gameState.phase !== 'guessing' || currentPlayer.team !== gameState.currentTeam || currentPlayer.role !== 'player') {
                return;
            }

            const card = gameState.cards[cardId];
            if (card.revealed) return;

            // ÙƒØ´Ù Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
            database.ref(`rooms/${roomId}/cards/${cardId}`).update({
                revealed: true,
                votes: {}
            });

            // Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ø¬Ù„
            addToLog(`${currentPlayer.name} Ø§Ø®ØªØ§Ø± ÙƒÙ„Ù…Ø© "${card.word}"`);

            // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù†ØªÙŠØ¬Ø©
            processCardSelection(card);
        }

        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
        function processCardSelection(card) {
            let endTurn = false;
            let gameEnded = false;

            switch (card.color) {
                case 'black':
                    // Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙŠØ®Ø³Ø±
                    const winner = gameState.currentTeam === 'red' ? 'blue' : 'red';
                    database.ref(`rooms/${roomId}/winner`).set(winner);
                    addToLog(`Ø§Ù„ÙØ±ÙŠÙ‚ ${gameState.currentTeam === 'red' ? 'Ø§Ù„Ø£Ø­Ù…Ø±' : 'Ø§Ù„Ø£Ø²Ø±Ù‚'} Ø§Ø®ØªØ§Ø± Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø³ÙˆØ¯Ø§Ø¡! ÙØ§Ø² Ø§Ù„ÙØ±ÙŠÙ‚ ${winner === 'red' ? 'Ø§Ù„Ø£Ø­Ù…Ø±' : 'Ø§Ù„Ø£Ø²Ø±Ù‚'}!`);
                    gameEnded = true;
                    break;

                case gameState.currentTeam:
                    // Ø¨Ø·Ø§Ù‚Ø© ØµØ­ÙŠØ­Ø©
                    const scoreKey = `${gameState.currentTeam}Score`;
                    const newScore = gameState[scoreKey] - 1;
                    database.ref(`rooms/${roomId}/${scoreKey}`).set(newScore);
                    
                    if (newScore === 0) {
                        database.ref(`rooms/${roomId}/winner`).set(gameState.currentTeam);
                        addToLog(`ÙØ§Ø² Ø§Ù„ÙØ±ÙŠÙ‚ ${gameState.currentTeam === 'red' ? 'Ø§Ù„Ø£Ø­Ù…Ø±' : 'Ø§Ù„Ø£Ø²Ø±Ù‚'}!`);
                        gameEnded = true;
                    } else {
                        const remaining = gameState.remainingGuesses - 1;
                        database.ref(`rooms/${roomId}/remainingGuesses`).set(remaining);
                        if (remaining === 0) {
                            endTurn = true;
                        }
                    }
                    break;

                case 'neutral':
                    // Ø¨Ø·Ø§Ù‚Ø© Ù…Ø­Ø§ÙŠØ¯Ø© - ÙŠÙ†ØªÙ‡ÙŠ Ø§Ù„Ø¯ÙˆØ±
                    endTurn = true;
                    break;

                default:
                    // Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø¢Ø®Ø±
                    const otherTeam = gameState.currentTeam === 'red' ? 'blue' : 'red';
                    const otherScoreKey = `${otherTeam}Score`;
                    const otherNewScore = gameState[otherScoreKey] - 1;
                    database.ref(`rooms/${roomId}/${otherScoreKey}`).set(otherNewScore);
                    
                    if (otherNewScore === 0) {
                        database.ref(`rooms/${roomId}/winner`).set(otherTeam);
                        addToLog(`ÙØ§Ø² Ø§Ù„ÙØ±ÙŠÙ‚ ${otherTeam === 'red' ? 'Ø§Ù„Ø£Ø­Ù…Ø±' : 'Ø§Ù„Ø£Ø²Ø±Ù‚'}!`);
                        gameEnded = true;
                    } else {
                        endTurn = true;
                    }
                    break;
            }

            if (!gameEnded && endTurn) {
                switchTurn();
            }
        }

        // ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø¯ÙˆØ±
        function switchTurn() {
            const nextTeam = gameState.currentTeam === 'red' ? 'blue' : 'red';
            database.ref(`rooms/${roomId}`).update({
                currentTeam: nextTeam,
                phase: 'hint',
                hint: null,
                remainingGuesses: 0
            });
        }

        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©
        function updateGameStatus() {
            const statusDiv = document.getElementById('gameStatus');
            
            if (gameState.winner) {
                statusDiv.textContent = `ÙØ§Ø² Ø§Ù„ÙØ±ÙŠÙ‚ ${gameState.winner === 'red' ? 'Ø§Ù„Ø£Ø­Ù…Ø±' : 'Ø§Ù„Ø£Ø²Ø±Ù‚'}!`;
                statusDiv.style.background = gameState.winner === 'red' ? '#ffebee' : '#e3f2fd';
            } else if (gameState.phase === 'waiting') {
                statusDiv.textContent = 'ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†...';
            } else if (gameState.phase === 'hint') {
                statusDiv.textContent = `Ø¯ÙˆØ± Ø§Ù„ÙØ±ÙŠÙ‚ ${gameState.currentTeam === 'red' ? 'Ø§Ù„Ø£Ø­Ù…Ø±' : 'Ø§Ù„Ø£Ø²Ø±Ù‚'} - Ø§Ù„Ø³Ø¨Ø§ÙŠ ÙŠÙƒØªØ¨ Ø§Ù„ØªÙ„Ù…ÙŠØ­`;
            } else if (gameState.phase === 'guessing') {
                statusDiv.textContent = `Ø¯ÙˆØ± Ø§Ù„ÙØ±ÙŠÙ‚ ${gameState.currentTeam === 'red' ? 'Ø§Ù„Ø£Ø­Ù…Ø±' : 'Ø§Ù„Ø£Ø²Ø±Ù‚'} - ${gameState.remainingGuesses} ØªØ®Ù…ÙŠÙ†Ø§Øª Ù…ØªØ¨Ù‚ÙŠØ©`;
            }
        }

        // ØªØ­Ø¯ÙŠØ« Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ØªÙ„Ù…ÙŠØ­
        function updateHintArea() {
            const hintArea = document.getElementById('hintArea');
            const currentHint = document.getElementById('currentHint');
            
            if (gameState.phase === 'hint' && currentPlayer.team === gameState.currentTeam && currentPlayer.role === 'spy') {
                hintArea.classList.add('active');
            } else {
                hintArea.classList.remove('active');
            }

            if (gameState.hint) {
                currentHint.textContent = `Ø§Ù„ØªÙ„Ù…ÙŠØ­: ${gameState.hint.text} (${gameState.hint.number})`;
                currentHint.classList.remove('hidden');
            } else {
                currentHint.classList.add('hidden');
            }
        }

        // Ø§Ø®ØªÙŠØ§Ø± Ø±Ù‚Ù…
        function selectNumber(num) {
            selectedNumber = num;
            document.querySelectorAll('.number-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            event.target.classList.add('selected');
        }

        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ„Ù…ÙŠØ­
        function sendHint() {
            const hintText = document.getElementById('hintInput').value.trim();
            if (!hintText) {
                alert('ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ù„ØªÙ„Ù…ÙŠØ­');
                return;
            }

            const hint = {
                text: hintText,
                number: selectedNumber,
                spy: currentPlayer.name
            };

            database.ref(`rooms/${roomId}`).update({
                hint: hint,
                phase: 'guessing',
                remainingGuesses: selectedNumber + 1
            });

            addToLog(`${currentPlayer.name} Ø£Ø¹Ø·Ù‰ ØªÙ„Ù…ÙŠØ­: "${hintText}" (${selectedNumber})`);
            
            document.getElementById('hintInput').value = '';
        }

        // Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¯ÙˆØ±
        function endTurn() {
            if (currentPlayer.team === gameState.currentTeam) {
                switchTurn();
                addToLog(`Ø§Ù„ÙØ±ÙŠÙ‚ ${gameState.currentTeam === 'red' ? 'Ø§Ù„Ø£Ø­Ù…Ø±' : 'Ø§Ù„Ø£Ø²Ø±Ù‚'} Ø£Ù†Ù‡Ù‰ Ø¯ÙˆØ±Ù‡`);
            }
        }

        // Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ø¬Ù„
        function addToLog(message) {
            const logEntry = {
                message: message,
                timestamp: Date.now(),
                team: gameState.currentTeam
            };

            database.ref(`rooms/${roomId}/log`).push(logEntry);
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¬Ù„
        function updateLog() {
            const logDiv = document.getElementById('gameLog');
            logDiv.innerHTML = '';

            if (gameState.log) {
                Object.values(gameState.log).slice(-10).forEach(entry => {
                    const entryDiv = document.createElement('div');
                    entryDiv.className = `log-entry ${entry.team || ''}`;
                    entryDiv.textContent = entry.message;
                    logDiv.appendChild(entryDiv);
                });
            }

            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ù„Ø¹Ø¨Ø©
        function resetGame() {
            if (!gameState || gameState.creator !== currentPlayer.id) {
                alert('ğŸš« ÙÙ‚Ø· Ù…Ù†Ø´Ø¦ Ø§Ù„ØºØ±ÙØ© ÙŠÙ…ÙƒÙ†Ù‡ Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ù„Ø¹Ø¨Ø©');
                return;
            }

            let confirmMsg = `ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ù„Ø¹Ø¨Ø©\n\n`;
            confirmMsg += `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ù„Ø¹Ø¨Ø©ØŸ\n\n`;
            confirmMsg += `âœ… Ø³ÙŠØªÙ… Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ù€:\n`;
            confirmMsg += `â€¢ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† ÙˆÙØ±Ù‚Ù‡Ù…\n`;
            confirmMsg += `â€¢ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø±ÙˆÙ…\n\n`;
            confirmMsg += `ğŸ”„ Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†:\n`;
            confirmMsg += `â€¢ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª (ÙƒÙ„Ù…Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©)\n`;
            confirmMsg += `â€¢ Ø§Ù„Ù†Ù‚Ø§Ø·\n`;
            confirmMsg += `â€¢ Ø³Ø¬Ù„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«\n`;
            confirmMsg += `â€¢ Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©`;

            if (!confirm(confirmMsg)) {
                return;
            }

            try {
                console.log('ğŸ”„ Ø¨Ø¯Ø¡ Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ù„Ø¹Ø¨Ø©...');
                
                const newCards = generateCards();
                console.log('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ø·Ø§Ù‚Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©');
                
                // Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† ÙˆØ§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
                const resetData = {
                    cards: newCards,
                    currentTeam: 'red',
                    phase: 'waiting', // Ø§Ù„Ø¨Ø¯Ø¡ Ø¨Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±
                    hint: null,
                    remainingGuesses: 0,
                    log: {},
                    redScore: 8,
                    blueScore: 7,
                    winner: null
                    // Ù„Ø§ Ù†ØºÙŠØ± players Ø£Ùˆ creator Ø£Ùˆ allowTeamChange
                };

                database.ref(`rooms/${roomId}`).update(resetData).then(() => {
                    console.log('âœ… ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ù„Ø¹Ø¨Ø© Ø¨Ù†Ø¬Ø§Ø­');
                    addToLog(`ğŸ”„ ${currentPlayer.name} Ø£Ø¹Ø§Ø¯ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù„Ø¹Ø¨Ø© - Ø¨Ø·Ø§Ù‚Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©!`);
                    alert('âœ… ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ù„Ø¹Ø¨Ø© Ø¨Ù†Ø¬Ø§Ø­!\n\nÙŠÙ…ÙƒÙ† Ù„Ù„ÙØ±Ù‚ Ø§Ù„Ø¨Ø¯Ø¡ Ø¨Ø§Ù„Ù„Ø¹Ø¨ Ø§Ù„Ø¢Ù†.');
                }).catch((error) => {
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ù„Ø¹Ø¨Ø©:', error);
                    alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ù„Ø¹Ø¨Ø©: ' + error.message);
                });
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:', error);
                alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©: ' + error.message);
            }
        }

        // Ø·Ø±Ø¯ Ù„Ø§Ø¹Ø¨
        function kickPlayer(playerId) {
            if (gameState.creator !== currentPlayer.id) {
                alert('ÙÙ‚Ø· Ù…Ù†Ø´Ø¦ Ø§Ù„ØºØ±ÙØ© ÙŠÙ…ÙƒÙ†Ù‡ Ø·Ø±Ø¯ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†');
                return;
            }

            database.ref(`rooms/${roomId}/players/${playerId}`).remove();
        }

        // ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø£Ùˆ ÙØ±ÙŠÙ‚Ù‡ (Ù„Ù„ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù‚Ø¯ÙŠÙ…)
        function changePlayerName() {
            togglePlayerDropdown();
        }

        // ØªØ±Ùƒ Ø§Ù„ÙØ±ÙŠÙ‚
        function leaveTeam() {
            if (!currentPlayer.team) {
                alert('Ø£Ù†Øª Ù„Ø³Øª ÙÙŠ Ø£ÙŠ ÙØ±ÙŠÙ‚');
                return;
            }

            if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ±Ùƒ Ø§Ù„ÙØ±ÙŠÙ‚ ${currentPlayer.team === 'red' ? 'Ø§Ù„Ø£Ø­Ù…Ø±' : 'Ø§Ù„Ø£Ø²Ø±Ù‚'}ØŸ`)) {
                return;
            }

            const oldTeam = currentPlayer.team;
            const oldRole = currentPlayer.role;
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹ Ø£ÙˆÙ„Ø§Ù‹
            currentPlayer.team = null;
            currentPlayer.role = 'player';
            
            // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            database.ref(`rooms/${roomId}/players/${currentPlayer.id}`).update({
                team: null,
                role: 'player'
            }).then(() => {
                console.log('Successfully left team');
                addToLog(`${currentPlayer.name} ØªØ±Ùƒ Ø§Ù„ÙØ±ÙŠÙ‚ ${oldTeam === 'red' ? 'Ø§Ù„Ø£Ø­Ù…Ø±' : 'Ø§Ù„Ø£Ø²Ø±Ù‚'}`);
                alert('ØªÙ… ØªØ±Ùƒ Ø§Ù„ÙØ±ÙŠÙ‚ Ø¨Ù†Ø¬Ø§Ø­');
            }).catch((error) => {
                console.error('Error leaving team:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ±Ùƒ Ø§Ù„ÙØ±ÙŠÙ‚');
                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù‚ÙŠÙ… ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£
                currentPlayer.team = oldTeam;
                currentPlayer.role = oldRole;
            });
        }

        // Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„Ø±ÙˆÙ…
        function leaveRoom() {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„Ø±ÙˆÙ…ØŸ Ø³ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ø§Ù„Ø±Ø§Ø¨Ø· Ù„Ù„Ø¹ÙˆØ¯Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.')) {
                return;
            }

            try {
                // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                if (database && roomId && currentPlayer) {
                    addToLog(`${currentPlayer.name} ØºØ§Ø¯Ø± Ø§Ù„Ø±ÙˆÙ…`);
                    database.ref(`rooms/${roomId}/players/${currentPlayer.id}`).remove().then(() => {
                        console.log('Player removed from room');
                    }).catch((error) => {
                        console.error('Error removing player:', error);
                    });
                }

                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
                currentPlayer = null;
                roomId = null;
                gameState = null;

                // Ø¥Ø²Ø§Ù„Ø© Ù…Ø¹Ø±Ù Ø§Ù„Ø±ÙˆÙ… Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·
                window.history.replaceState({}, '', window.location.pathname);

                // Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
                document.getElementById('gameScreen').style.display = 'none';
                document.getElementById('startScreen').style.display = 'flex';
                document.getElementById('playerName').value = '';

                alert('ØªÙ… Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„Ø±ÙˆÙ… Ø¨Ù†Ø¬Ø§Ø­');
            } catch (error) {
                console.error('Error leaving room:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„Ø±ÙˆÙ…');
            }
        }

        // Ø¥ØºÙ„Ø§Ù‚ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©
        function closeAllDropdowns() {
            document.querySelectorAll('.dropdown-content').forEach(dropdown => {
                dropdown.classList.remove('show');
            });
        }

        // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.dropdown')) {
                closeAllDropdowns();
            }
        });

        // ØªØ¨Ø¯ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†
        function togglePlayersDropdown() {
            closeAllDropdowns();
            const dropdown = document.getElementById('playersDropdown');
            dropdown.classList.toggle('show');
            if (dropdown.classList.contains('show')) {
                updatePlayersDropdown();
            }
        }

        // ØªØ­Ø¯ÙŠØ« Ù…Ø­ØªÙˆÙ‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†
        function updatePlayersDropdown() {
            if (!gameState || !gameState.players) {
                return;
            }

            const container = document.getElementById('playersDropdownContent');
            const players = Object.values(gameState.players);
            const isCreator = gameState.creator === currentPlayer.id;

            let content = '';

            // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø±ÙˆÙ…
            content += `<div class="dropdown-info">`;
            content += `ğŸ  Ø±Ù‚Ù… Ø§Ù„Ø±ÙˆÙ…: <strong>${roomId}</strong><br>`;
            content += `ğŸ‘¥ Ø¹Ø¯Ø¯ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†: <strong>${players.length}</strong><br>`;
            content += `ğŸ® Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©: <strong>${getGamePhaseText()}</strong>`;
            content += `</div>`;

            // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø­Ø³Ø¨ Ø§Ù„ÙØ±ÙŠÙ‚
            const redTeam = players.filter(p => p.team === 'red');
            const blueTeam = players.filter(p => p.team === 'blue');
            const noTeam = players.filter(p => !p.team);

            // Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø­Ù…Ø±
            if (redTeam.length > 0) {
                content += `<div class="dropdown-section">`;
                content += `<div class="dropdown-section-title">ğŸ”´ Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø­Ù…Ø± (${redTeam.length})</div>`;
                redTeam.forEach(player => {
                    content += createPlayerItem(player, isCreator);
                });
                content += `</div>`;
            }

            // Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø²Ø±Ù‚
            if (blueTeam.length > 0) {
                content += `<div class="dropdown-section">`;
                content += `<div class="dropdown-section-title">ğŸ”µ Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø²Ø±Ù‚ (${blueTeam.length})</div>`;
                blueTeam.forEach(player => {
                    content += createPlayerItem(player, isCreator);
                });
                content += `</div>`;
            }

            // Ø¨Ø¯ÙˆÙ† ÙØ±ÙŠÙ‚
            if (noTeam.length > 0) {
                content += `<div class="dropdown-section">`;
                content += `<div class="dropdown-section-title">âšª Ø¨Ø¯ÙˆÙ† ÙØ±ÙŠÙ‚ (${noTeam.length})</div>`;
                noTeam.forEach(player => {
                    content += createPlayerItem(player, isCreator);
                });
                content += `</div>`;
            }

            // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ù†Ø´Ø¦
            if (isCreator) {
                content += `<div class="dropdown-info">`;
                content += `ğŸ‘‘ <strong>ØµÙ„Ø§Ø­ÙŠØ§ØªÙƒ ÙƒÙ…Ù†Ø´Ø¦:</strong><br>`;
                content += `â€¢ Ø·Ø±Ø¯ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†<br>`;
                content += `â€¢ Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ù„Ø¹Ø¨Ø©<br>`;
                content += `â€¢ Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙØ±Ù‚`;
                content += `</div>`;
            } else {
                const creatorName = gameState.players[gameState.creator]?.name || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                content += `<div class="dropdown-info">`;
                content += `ğŸ‘‘ Ù…Ù†Ø´Ø¦ Ø§Ù„Ø±ÙˆÙ…: <strong>${creatorName}</strong>`;
                content += `</div>`;
            }

            container.innerHTML = content;
        }

        // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†ØµØ± Ù„Ø§Ø¹Ø¨
        function createPlayerItem(player, isCreator) {
            const teamClass = player.team || 'no-team';
            const statusClass = player.online ? 'online' : 'offline';
            const isCurrentPlayer = player.id === currentPlayer.id;
            
            let roleText = '';
            let roleClass = '';
            
            if (player.id === gameState.creator) {
                roleText = 'Ù…Ù†Ø´Ø¦';
                roleClass = 'creator';
            } else if (player.role === 'spy') {
                roleText = 'Ø³Ø¨Ø§ÙŠ';
                roleClass = 'spy';
            } else {
                roleText = 'Ù„Ø§Ø¹Ø¨';
                roleClass = '';
            }

            let item = `<div class="dropdown-item ${teamClass}">`;
            item += `<div>`;
            item += `<span class="player-role ${roleClass}">${roleText}</span>`;
            item += `${player.name}`;
            item += `<span class="status-indicator ${statusClass}"></span>`;
            item += `</div>`;
            
            if (isCreator && !isCurrentPlayer) {
                item += `<button class="dropdown-button danger" onclick="kickPlayer('${player.id}')">Ø·Ø±Ø¯</button>`;
            }
            
            item += `</div>`;
            
            return item;
        }

        // ØªØ¨Ø¯ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„
        function toggleResetDropdown() {
            closeAllDropdowns();
            const dropdown = document.getElementById('resetDropdown');
            dropdown.classList.toggle('show');
            if (dropdown.classList.contains('show')) {
                updateResetDropdown();
            }
        }

        // ØªØ­Ø¯ÙŠØ« Ù…Ø­ØªÙˆÙ‰ Ù‚Ø§Ø¦Ù…Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„
        function updateResetDropdown() {
            const container = document.getElementById('resetDropdownContent');
            const isCreator = gameState && gameState.creator === currentPlayer.id;

            let content = '';

            if (!isCreator) {
                content += `<div class="dropdown-info">`;
                content += `ğŸš« ÙÙ‚Ø· Ù…Ù†Ø´Ø¦ Ø§Ù„Ø±ÙˆÙ… ÙŠÙ…ÙƒÙ†Ù‡ Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ù„Ø¹Ø¨Ø©`;
                content += `</div>`;
            } else {
                content += `<div class="dropdown-info">`;
                content += `ğŸ”„ <strong>Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ù„Ø¹Ø¨Ø©</strong><br><br>`;
                content += `âœ… <strong>Ø³ÙŠØªÙ… Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ù€:</strong><br>`;
                content += `â€¢ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† ÙˆÙØ±Ù‚Ù‡Ù…<br>`;
                content += `â€¢ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø±ÙˆÙ…<br><br>`;
                content += `ğŸ”„ <strong>Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†:</strong><br>`;
                content += `â€¢ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª (ÙƒÙ„Ù…Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©)<br>`;
                content += `â€¢ Ø§Ù„Ù†Ù‚Ø§Ø· ÙˆØ§Ù„Ø³Ø¬Ù„<br>`;
                content += `â€¢ Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©`;
                content += `</div>`;
                
                content += `<button class="dropdown-button warning" onclick="resetGame(); closeAllDropdowns();">ØªØ£ÙƒÙŠØ¯ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„</button>`;
            }

            container.innerHTML = content;
        }

        // ØªØ¨Ø¯ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨
        function togglePlayerDropdown() {
            closeAllDropdowns();
            const dropdown = document.getElementById('playerDropdown');
            dropdown.classList.toggle('show');
            if (dropdown.classList.contains('show')) {
                updatePlayerDropdown();
            }
        }

        // ØªØ­Ø¯ÙŠØ« Ù…Ø­ØªÙˆÙ‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨
        function updatePlayerDropdown() {
            const container = document.getElementById('playerDropdownContent');
            const isCreator = gameState && gameState.creator === currentPlayer.id;

            let content = '';

            // ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù…
            content += `<div class="dropdown-section">`;
            content += `<div class="dropdown-section-title">ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù…</div>`;
            content += `<input type="text" id="newPlayerName" value="${currentPlayer.name}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 10px; font-size: 0.9rem;" maxlength="20">`;
            content += `<button class="dropdown-button" onclick="changePlayerNameDirect(); closeAllDropdowns();">ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù…</button>`;
            content += `</div>`;

            // ØªØºÙŠÙŠØ± Ø§Ù„ÙØ±ÙŠÙ‚ - ÙÙ‚Ø· Ø²Ø± ØªØ±Ùƒ Ø§Ù„ÙØ±ÙŠÙ‚ Ø¥Ø°Ø§ ÙƒØ§Ù† ÙÙŠ ÙØ±ÙŠÙ‚
            if (gameState && gameState.allowTeamChange !== false && currentPlayer.team) {
                content += `<div class="dropdown-section">`;
                content += `<div class="dropdown-section-title">Ø§Ù„ÙØ±ÙŠÙ‚</div>`;
                content += `<button class="dropdown-button warning" onclick="leaveTeam(); closeAllDropdowns();">ØªØ±Ùƒ Ø§Ù„ÙØ±ÙŠÙ‚</button>`;
                content += `</div>`;
            }

            // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ù†Ø´Ø¦
            if (isCreator) {
                content += `<div class="dropdown-section">`;
                content += `<div class="dropdown-section-title">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ù†Ø´Ø¦</div>`;
                const allowText = gameState.allowTeamChange !== false ? 'Ù…Ù†Ø¹ ØªØºÙŠÙŠØ± Ø§Ù„ÙØ±Ù‚' : 'Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨ØªØºÙŠÙŠØ± Ø§Ù„ÙØ±Ù‚';
                content += `<button class="dropdown-button" onclick="toggleTeamChangeSettings(); closeAllDropdowns();">${allowText}</button>`;
                content += `</div>`;
            }

            // Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„Ø±ÙˆÙ…
            content += `<div class="dropdown-section">`;
            content += `<button class="dropdown-button danger" onclick="leaveRoom(); closeAllDropdowns();">Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„Ø±ÙˆÙ…</button>`;
            content += `</div>`;

            container.innerHTML = content;
        }

        // ØªØ¨Ø¯ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø§Ø¨Ø·
        function toggleLinkDropdown() {
            closeAllDropdowns();
            const dropdown = document.getElementById('linkDropdown');
            dropdown.classList.toggle('show');
            if (dropdown.classList.contains('show')) {
                updateLinkDropdown();
            }
        }

        // ØªØ­Ø¯ÙŠØ« Ù…Ø­ØªÙˆÙ‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø§Ø¨Ø·
        function updateLinkDropdown() {
            const container = document.getElementById('linkDropdownContent');
            const link = `https://mayadinq8.github.io/marabit/?room=${roomId}`;

            let content = '';
            
            content += `<div class="dropdown-info">`;
            content += `Ø´Ø§Ø±Ùƒ Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ø¹ Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ Ù„Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ø±ÙˆÙ…:`;
            content += `</div>`;
            
            content += `<div class="dropdown-link">${link}</div>`;
            
            content += `<button class="dropdown-button success" onclick="copyRoomLinkFromDropdown(); closeAllDropdowns();">Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·</button>`;

            container.innerHTML = content;
        }

        // Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©
        function copyRoomLinkFromDropdown() {
            const link = `https://mayadinq8.github.io/marabit/?room=${roomId}`;
            
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(link).then(() => {
                    alert('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· Ø¨Ù†Ø¬Ø§Ø­!');
                }).catch(() => {
                    fallbackCopyMethod(link);
                });
            } else {
                fallbackCopyMethod(link);
            }
        }

        // ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù… Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
        function changePlayerNamePrompt() {
            const newName = prompt('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯:', currentPlayer.name);
            if (newName && newName.trim() && newName.trim() !== currentPlayer.name) {
                if (newName.trim().length > 20) {
                    alert('Ø§Ù„Ø§Ø³Ù… Ø·ÙˆÙŠÙ„ Ø¬Ø¯Ø§Ù‹ (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 20 Ø­Ø±Ù)');
                    return;
                }
                
                const oldName = currentPlayer.name;
                currentPlayer.name = newName.trim();
                
                localStorage.setItem('playerName', currentPlayer.name);
                
                database.ref(`rooms/${roomId}/players/${currentPlayer.id}/name`).set(currentPlayer.name).then(() => {
                    document.getElementById('currentPlayerName').textContent = currentPlayer.name;
                    addToLog(`${oldName} ØºÙŠØ± Ø§Ø³Ù…Ù‡ Ø¥Ù„Ù‰ ${currentPlayer.name}`);
                    alert('ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù… Ø¨Ù†Ø¬Ø§Ø­!');
                }).catch((error) => {
                    console.error('Error changing name:', error);
                    alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù…');
                    currentPlayer.name = oldName;
                    localStorage.setItem('playerName', oldName);
                });
            }
        }

        // ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù… Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ù† Ù…Ø±Ø¨Ø¹ Ø§Ù„Ù†Øµ
        function changePlayerNameDirect() {
            const newNameInput = document.getElementById('newPlayerName');
            if (!newNameInput) return;
            
            const newName = newNameInput.value.trim();
            if (!newName || newName === currentPlayer.name) {
                alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø¬Ø¯ÙŠØ¯ Ù…Ø®ØªÙ„Ù');
                return;
            }
            
            if (newName.length > 20) {
                alert('Ø§Ù„Ø§Ø³Ù… Ø·ÙˆÙŠÙ„ Ø¬Ø¯Ø§Ù‹ (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 20 Ø­Ø±Ù)');
                return;
            }
            
            const oldName = currentPlayer.name;
            currentPlayer.name = newName;
            
            localStorage.setItem('playerName', currentPlayer.name);
            
            database.ref(`rooms/${roomId}/players/${currentPlayer.id}/name`).set(currentPlayer.name).then(() => {
                document.getElementById('currentPlayerName').textContent = currentPlayer.name;
                addToLog(`${oldName} ØºÙŠØ± Ø§Ø³Ù…Ù‡ Ø¥Ù„Ù‰ ${currentPlayer.name}`);
                alert('ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù… Ø¨Ù†Ø¬Ø§Ø­!');
            }).catch((error) => {
                console.error('Error changing name:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù…');
                currentPlayer.name = oldName;
                localStorage.setItem('playerName', oldName);
                document.getElementById('currentPlayerName').textContent = oldName;
            });
        }

        // ØªØ¨Ø¯ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ØªØºÙŠÙŠØ± Ø§Ù„ÙØ±Ù‚
        function toggleTeamChangeSettings() {
            const newSetting = !(gameState.allowTeamChange !== false);
            
            database.ref(`rooms/${roomId}/allowTeamChange`).set(newSetting).then(() => {
                const resultMsg = newSetting ? 'ØªÙ… Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨ØªØºÙŠÙŠØ± Ø§Ù„ÙØ±Ù‚' : 'ØªÙ… Ù…Ù†Ø¹ ØªØºÙŠÙŠØ± Ø§Ù„ÙØ±Ù‚';
                alert(resultMsg);
                addToLog(`Ù…Ù†Ø´Ø¦ Ø§Ù„Ø±ÙˆÙ… ${newSetting ? 'Ø³Ù…Ø­ Ø¨Ù€' : 'Ù…Ù†Ø¹'} ØªØºÙŠÙŠØ± Ø§Ù„ÙØ±Ù‚`);
            }).catch((error) => {
                console.error('Error changing team setting:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØºÙŠÙŠØ± Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯');
            });
        }
        
        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù†Øµ Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©
        function getGamePhaseText() {
            if (!gameState) return 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
            
            if (gameState.winner) {
                return `Ø§Ù†ØªÙ‡Øª - ÙØ§Ø² Ø§Ù„ÙØ±ÙŠÙ‚ ${gameState.winner === 'red' ? 'Ø§Ù„Ø£Ø­Ù…Ø±' : 'Ø§Ù„Ø£Ø²Ø±Ù‚'}`;
            }
            
            switch (gameState.phase) {
                case 'waiting':
                    return 'ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†';
                case 'hint':
                    return `Ø¯ÙˆØ± ${gameState.currentTeam === 'red' ? 'Ø§Ù„Ø£Ø­Ù…Ø±' : 'Ø§Ù„Ø£Ø²Ø±Ù‚'} - ÙƒØªØ§Ø¨Ø© Ø§Ù„ØªÙ„Ù…ÙŠØ­`;
                case 'guessing':
                    return `Ø¯ÙˆØ± ${gameState.currentTeam === 'red' ? 'Ø§Ù„Ø£Ø­Ù…Ø±' : 'Ø§Ù„Ø£Ø²Ø±Ù‚'} - Ø§Ù„ØªØ®Ù…ÙŠÙ†`;
                default:
                    return 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
            }
        }

        // Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„ØºØ±ÙØ© (Ù„Ù„ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù‚Ø¯ÙŠÙ…)
        function copyRoomLink() {
            toggleLinkDropdown();
        }

        // Ø·Ø±ÙŠÙ‚Ø© Ø¨Ø¯ÙŠÙ„Ø© Ù„Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·
        function fallbackCopyMethod(link) {
            const textArea = document.createElement('textarea');
            textArea.value = link;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                document.execCommand('copy');
                alert('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·!');
            } catch (error) {
                console.error('Copy failed:', error);
                prompt('Ø§Ù†Ø³Ø® Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø· ÙŠØ¯ÙˆÙŠØ§Ù‹:', link);
            } finally {
                document.body.removeChild(textArea);
            }
        }

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ø¹Ø±Ù ØºØ±ÙØ© ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø· Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        window.addEventListener('load', () => {
            const roomFromUrl = getRoomIdFromUrl();
            if (roomFromUrl) {
                roomId = roomFromUrl;
                // ØªØ­Ø¯ÙŠØ« Ø¹Ù†ÙˆØ§Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ù„Ù„Ø§Ù†Ø¶Ù…Ø§Ù…
                document.querySelector('.game-title').textContent = 'Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ø±ÙˆÙ…';
                document.querySelector('.start-btn').textContent = 'Ø§Ù†Ø¶Ù… Ù„Ù„Ø±ÙˆÙ…';
                document.querySelector('.name-input').placeholder = 'Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ù„Ù„Ø§Ù†Ø¶Ù…Ø§Ù…';
                
                // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø±ÙˆÙ…
                const roomInfo = document.createElement('div');
                roomInfo.style.cssText = `
                    background: #e3f2fd;
                    padding: 15px;
                    border-radius: 10px;
                    margin-bottom: 20px;
                    text-align: center;
                    border: 2px solid #2196f3;
                `;
                roomInfo.innerHTML = `
                    <div style="font-size: 1.1rem; font-weight: bold; color: #1976d2; margin-bottom: 5px;">
                        ğŸ® Ø¯Ø¹ÙˆØ© Ù„Ù„Ø§Ù†Ø¶Ù…Ø§Ù…
                    </div>
                    <div style="font-size: 0.9rem; color: #666;">
                        Ø±Ù‚Ù… Ø§Ù„Ø±ÙˆÙ…: <strong>${roomFromUrl}</strong>
                    </div>
                `;
                
                const startScreen = document.querySelector('.start-screen');
                const nameInput = document.getElementById('playerName');
                startScreen.insertBefore(roomInfo, nameInput);
                
                // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø­ÙÙˆØ¸ Ø¥Ù† ÙˆØ¬Ø¯
                const savedName = localStorage.getItem('playerName');
                if (savedName) {
                    nameInput.value = savedName;
                }
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98c245cdd63a5cea',t:'MTc2MDA1ODk5MC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>

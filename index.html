<!doctype html>
<html lang="ar" dir="rtl">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ŸÑÿπÿ®ÿ© ŸÖÿ±ÿßÿ®ÿ∑</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&amp;display=swap" rel="stylesheet">
  <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Tajawal', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: #fff;
            overflow-x: hidden;
        }
        
        /* Main Screen */
        .main-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .logo {
            font-size: 4rem;
            font-weight: 800;
            background: linear-gradient(45deg, #e94560, #0f3460, #e94560);
            background-size: 200% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: gradientShift 3s ease infinite;
            margin-bottom: 10px;
            text-shadow: 0 0 30px rgba(233, 69, 96, 0.3);
        }
        
        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        
        .subtitle {
            color: #a0a0a0;
            margin-bottom: 40px;
            font-size: 1.1rem;
        }
        
        .input-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 100%;
            max-width: 320px;
        }
        
        .input-field {
            padding: 16px 20px;
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            background: rgba(255,255,255,0.05);
            color: #fff;
            font-size: 1.1rem;
            font-family: 'Tajawal', sans-serif;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .input-field:focus {
            outline: none;
            border-color: #e94560;
            background: rgba(233, 69, 96, 0.1);
            box-shadow: 0 0 20px rgba(233, 69, 96, 0.2);
        }
        
        .input-field::placeholder {
            color: #666;
        }
        
        .btn {
            padding: 16px 32px;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 700;
            font-family: 'Tajawal', sans-serif;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #e94560, #c73e54);
            color: #fff;
            box-shadow: 0 4px 15px rgba(233, 69, 96, 0.4);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(233, 69, 96, 0.5);
        }
        
        .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: #fff;
            border: 2px solid rgba(255,255,255,0.2);
        }
        
        .btn-secondary:hover {
            background: rgba(255,255,255,0.15);
            border-color: rgba(255,255,255,0.3);
        }
        
        .or-divider {
            display: flex;
            align-items: center;
            gap: 15px;
            color: #666;
            margin: 10px 0;
        }
        
        .or-divider::before,
        .or-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: rgba(255,255,255,0.1);
        }
        
        /* Game Screen */
        .game-screen {
            display: none;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }
        
        /* Top Bar */
        .top-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            background: rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            flex-shrink: 0;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .top-bar-section {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .top-btn {
            padding: 6px 10px;
            border: none;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 600;
            font-family: 'Tajawal', sans-serif;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
        }
        
        .top-btn-icon {
            background: rgba(255,255,255,0.1);
            color: #fff;
        }
        
        .top-btn-icon:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .players-count {
            background: rgba(233, 69, 96, 0.2);
            color: #e94560;
            padding: 6px 10px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
        }
        
        /* Turn Indicator */
        .turn-indicator {
            text-align: center;
            padding: 6px;
            background: rgba(0,0,0,0.2);
            font-weight: 700;
            font-size: 0.9rem;
            flex-shrink: 0;
        }
        
        .turn-red { background: linear-gradient(90deg, transparent, rgba(239, 68, 68, 0.3), transparent); color: #fca5a5; }
        .turn-blue { background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.3), transparent); color: #93c5fd; }
        
        /* Main Game Area */
        .game-content {
            display: flex;
            flex: 1;
            overflow: hidden;
            min-height: 0;
        }
        
        /* Team Panels */
        .team-panel {
            width: 110px;
            display: flex;
            flex-direction: column;
            padding: 6px;
            flex-shrink: 0;
            overflow-y: auto;
        }
        
        .team-panel.red { background: linear-gradient(180deg, rgba(239, 68, 68, 0.15), rgba(239, 68, 68, 0.05)); }
        .team-panel.blue { background: linear-gradient(180deg, rgba(59, 130, 246, 0.15), rgba(59, 130, 246, 0.05)); }
        
        .team-header {
            text-align: center;
            padding: 6px;
            border-radius: 8px;
            margin-bottom: 6px;
            font-weight: 700;
            font-size: 0.85rem;
        }
        
        .team-header.red { background: rgba(239, 68, 68, 0.3); color: #fca5a5; }
        .team-header.blue { background: rgba(59, 130, 246, 0.3); color: #93c5fd; }
        
        .team-score {
            font-size: 1.5rem;
            font-weight: 800;
        }
        
        .team-section {
            margin-bottom: 8px;
        }
        
        .section-title {
            font-size: 0.7rem;
            color: #888;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .player-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 4px 6px;
            background: rgba(255,255,255,0.05);
            border-radius: 6px;
            margin-bottom: 3px;
            font-size: 0.75rem;
            transition: all 0.2s ease;
        }
        
        .player-item.offline {
            opacity: 0.4;
        }
        
        .player-item.red { border-right: 2px solid #ef4444; }
        .player-item.blue { border-right: 2px solid #3b82f6; }
        
        .join-team-btn {
            width: 100%;
            padding: 6px;
            border: 2px dashed rgba(255,255,255,0.2);
            border-radius: 6px;
            background: transparent;
            color: #888;
            font-size: 0.7rem;
            font-family: 'Tajawal', sans-serif;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-top: 4px;
        }
        
        .join-team-btn:hover {
            border-color: rgba(255,255,255,0.4);
            color: #fff;
        }
        
        /* Center Area */
        .center-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 6px;
            min-width: 0;
            overflow: hidden;
        }
        
        /* Cards Grid */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 4px;
            flex: 1;
            min-height: 0;
        }
        
        .card {
            position: relative;
            background: linear-gradient(145deg, #d4c4a8, #c9b896);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            overflow: hidden;
            min-height: 0;
        }
        
        .card:hover:not(.revealed) {
            transform: scale(1.02);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        
        .card.revealed {
            cursor: default;
        }
        
        .card.revealed.red { background: linear-gradient(145deg, #ef4444, #dc2626); }
        .card.revealed.blue { background: linear-gradient(145deg, #3b82f6, #2563eb); }
        .card.revealed.black { background: linear-gradient(145deg, #1f2937, #111827); }
        .card.revealed.neutral { background: linear-gradient(145deg, #9ca3af, #6b7280); }
        
        .card-word {
            font-size: clamp(0.55rem, 2vw, 0.8rem);
            font-weight: 700;
            color: #2d2416;
            text-align: center;
            padding: 2px;
            word-break: break-word;
            line-height: 1.2;
        }
        
        .card.revealed .card-word {
            color: #fff;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }
        
        /* Spy View Colors */
        .card.spy-red { border: 3px solid #ef4444; box-shadow: inset 0 0 10px rgba(239, 68, 68, 0.3); }
        .card.spy-blue { border: 3px solid #3b82f6; box-shadow: inset 0 0 10px rgba(59, 130, 246, 0.3); }
        .card.spy-black { border: 3px solid #1f2937; box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5); }
        
        /* Hand Button */
        .hand-btn {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: #fbbf24;
            border: none;
            border-radius: 50%;
            font-size: 0.6rem;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10;
            transition: all 0.2s ease;
        }
        
        .hand-btn:hover {
            transform: scale(1.1);
            background: #f59e0b;
        }
        
        .card.can-vote .hand-btn {
            display: flex;
        }
        
        /* Voters Display */
        .voters-display {
            position: absolute;
            bottom: 2px;
            left: 2px;
            right: 2px;
            display: flex;
            flex-wrap: wrap;
            gap: 2px;
            justify-content: center;
        }
        
        .voter-name {
            font-size: 0.5rem;
            padding: 1px 3px;
            border-radius: 3px;
            color: #fff;
        }
        
        .voter-name.red { background: rgba(239, 68, 68, 0.8); }
        .voter-name.blue { background: rgba(59, 130, 246, 0.8); }
        
        /* Activity Log */
        .activity-log {
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            margin-top: 6px;
            padding: 6px;
            height: 80px;
            overflow-y: auto;
            flex-shrink: 0;
        }
        
        .activity-title {
            font-size: 0.7rem;
            color: #888;
            margin-bottom: 4px;
        }
        
        .activity-item {
            font-size: 0.65rem;
            padding: 3px 6px;
            background: rgba(255,255,255,0.05);
            border-radius: 4px;
            margin-bottom: 2px;
            color: #ccc;
        }
        
        .activity-item.red { border-right: 2px solid #ef4444; }
        .activity-item.blue { border-right: 2px solid #3b82f6; }
        .activity-item.winner { background: linear-gradient(90deg, rgba(34, 197, 94, 0.2), transparent); color: #4ade80; font-weight: 700; }
        
        /* Hint Input */
        .hint-section {
            background: rgba(0,0,0,0.3);
            padding: 8px;
            border-radius: 8px;
            margin-top: 6px;
            flex-shrink: 0;
        }
        
        .hint-input-row {
            display: flex;
            gap: 6px;
            align-items: center;
        }
        
        .hint-input {
            flex: 1;
            padding: 8px 12px;
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            color: #fff;
            font-size: 0.9rem;
            font-family: 'Tajawal', sans-serif;
        }
        
        .hint-input:focus {
            outline: none;
            border-color: #e94560;
        }
        
        .hint-count-select {
            padding: 8px;
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            color: #fff;
            font-size: 0.9rem;
            font-family: 'Tajawal', sans-serif;
        }
        
        .send-hint-btn {
            padding: 8px 16px;
            background: linear-gradient(135deg, #e94560, #c73e54);
            border: none;
            border-radius: 8px;
            color: #fff;
            font-weight: 700;
            font-family: 'Tajawal', sans-serif;
            cursor: pointer;
        }
        
        .current-hint {
            text-align: center;
            padding: 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            margin-top: 6px;
        }
        
        .hint-text {
            font-size: 1.1rem;
            font-weight: 700;
            color: #fbbf24;
        }
        
        .hint-count {
            font-size: 0.8rem;
            color: #888;
        }
        
        .end-turn-btn {
            margin-top: 6px;
            width: 100%;
            padding: 8px;
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            color: #fff;
            font-weight: 600;
            font-family: 'Tajawal', sans-serif;
            cursor: pointer;
        }
        
        .end-turn-btn:hover {
            background: rgba(255,255,255,0.15);
        }
        
        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal {
            background: linear-gradient(145deg, #1e293b, #0f172a);
            border-radius: 16px;
            padding: 24px;
            max-width: 400px;
            width: 100%;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .modal-title {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 16px;
            text-align: center;
        }
        
        .modal-content {
            margin-bottom: 16px;
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
        }
        
        .modal-buttons .btn {
            flex: 1;
        }
        
        /* Players Modal List */
        .players-modal-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .player-modal-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            margin-bottom: 8px;
        }
        
        .player-modal-item.offline {
            opacity: 0.5;
        }
        
        .kick-btn {
            padding: 4px 10px;
            background: #ef4444;
            border: none;
            border-radius: 6px;
            color: #fff;
            font-size: 0.75rem;
            font-family: 'Tajawal', sans-serif;
            cursor: pointer;
        }
        
        /* Winner Overlay */
        .winner-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        
        .winner-overlay.active {
            display: flex;
        }
        
        .winner-content {
            text-align: center;
            animation: winnerPop 0.5s ease;
        }
        
        @keyframes winnerPop {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .winner-emoji {
            font-size: 5rem;
            margin-bottom: 20px;
        }
        
        .winner-text {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 10px;
        }
        
        .winner-text.red { color: #ef4444; }
        .winner-text.blue { color: #3b82f6; }
        
        .winner-reason {
            font-size: 1rem;
            color: #888;
            margin-bottom: 30px;
        }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #22c55e;
            color: #fff;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            z-index: 3000;
            transition: transform 0.3s ease;
        }
        
        .toast.active {
            transform: translateX(-50%) translateY(0);
        }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            .team-panel {
                width: 85px;
                padding: 4px;
            }
            
            .team-header {
                padding: 4px;
                font-size: 0.75rem;
            }
            
            .team-score {
                font-size: 1.2rem;
            }
            
            .player-item {
                font-size: 0.65rem;
                padding: 3px 4px;
            }
            
            .cards-grid {
                gap: 3px;
            }
            
            .card {
                border-radius: 4px;
            }
            
            .card-word {
                font-size: clamp(0.5rem, 2.5vw, 0.7rem);
            }
            
            .activity-log {
                height: 60px;
            }
            
            .top-btn {
                padding: 4px 8px;
                font-size: 0.7rem;
            }
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body><!-- Main Screen -->
  <div class="main-screen" id="mainScreen">
   <div class="logo">
    ŸÖÿ±ÿßÿ®ÿ∑
   </div>
   <p class="subtitle">ŸÑÿπÿ®ÿ© ÿßŸÑŸÉŸÑŸÖÿßÿ™ ŸàÿßŸÑÿ™ÿÆŸÖŸäŸÜ ÿßŸÑÿ¨ŸÖÿßÿπŸäÿ©</p>
   <div class="input-container"><input type="text" class="input-field" id="playerName" placeholder="ÿ£ÿØÿÆŸÑ ÿßÿ≥ŸÖŸÉ" maxlength="15"> <button class="btn btn-primary" id="createGameBtn">üéÆ ÿ•ŸÜÿ¥ÿßÿ° ÿ∫ÿ±ŸÅÿ© ÿ¨ÿØŸäÿØÿ©</button>
    <div class="or-divider">
     ÿ£Ÿà
    </div><input type="text" class="input-field" id="roomCodeInput" placeholder="ÿ£ÿØÿÆŸÑ ŸÉŸàÿØ ÿßŸÑÿ∫ÿ±ŸÅÿ©"> <button class="btn btn-secondary" id="joinGameBtn">üö™ ÿßŸÜÿ∂ŸÖÿßŸÖ ŸÑŸÑÿ∫ÿ±ŸÅÿ©</button>
   </div>
  </div><!-- Game Screen -->
  <div class="game-screen" id="gameScreen"><!-- Top Bar -->
   <div class="top-bar">
    <div class="top-bar-section">
     <div class="players-count" id="playersCount" onclick="showPlayersModal()">
      üë• <span>0</span>
     </div><button class="top-btn top-btn-icon" id="resetGameBtn" style="display:none;">üîÑ ÿ•ÿπÿßÿØÿ©</button>
    </div>
    <div class="top-bar-section"><button class="top-btn top-btn-icon" id="playerNameBtn">üë§ <span id="currentPlayerName"></span></button> <button class="top-btn top-btn-icon" onclick="copyRoomLink()">üîó ŸÜÿ≥ÿÆ ÿßŸÑÿ±ÿßÿ®ÿ∑</button>
    </div>
   </div><!-- Turn Indicator -->
   <div class="turn-indicator" id="turnIndicator">
    ŸÅŸä ÿßŸÜÿ™ÿ∏ÿßÿ± ÿßŸÑŸÑÿßÿπÿ®ŸäŸÜ...
   </div><!-- Main Game Content -->
   <div class="game-content"><!-- Red Team Panel -->
    <div class="team-panel red">
     <div class="team-header red">
      <div>
       ÿßŸÑŸÅÿ±ŸäŸÇ ÿßŸÑÿ£ÿ≠ŸÖÿ±
      </div>
      <div class="team-score" id="redScore">
       8
      </div>
     </div>
     <div class="team-section">
      <div class="section-title">
       üïµÔ∏è ÿßŸÑÿ¨ÿßÿ≥Ÿàÿ≥
      </div>
      <div id="redSpyList"></div><button class="join-team-btn" onclick="joinTeam('red', 'spy')">+ ÿ¨ÿßÿ≥Ÿàÿ≥</button>
     </div>
     <div class="team-section">
      <div class="section-title">
       üë• ÿßŸÑŸÑÿßÿπÿ®ŸàŸÜ
      </div>
      <div id="redPlayersList"></div><button class="join-team-btn" onclick="joinTeam('red', 'player')">+ ŸÑÿßÿπÿ®</button>
     </div>
    </div><!-- Center Area -->
    <div class="center-area">
     <div class="cards-grid" id="cardsGrid"></div><!-- Activity Log -->
     <div class="activity-log">
      <div class="activity-title">
       üìã ÿ≥ÿ¨ŸÑ ÿßŸÑÿ£ÿ≠ÿØÿßÿ´
      </div>
      <div id="activityList"></div>
     </div><!-- Hint Section -->
     <div class="hint-section" id="hintSection" style="display:none;">
      <div class="hint-input-row" id="hintInputRow" style="display:none;"><input type="text" class="hint-input" id="hintInput" placeholder="ÿ£ÿØÿÆŸÑ ÿßŸÑÿ™ŸÑŸÖŸäÿ≠..."> <select class="hint-count-select" id="hintCountSelect"> <option value="1">1</option> <option value="2">2</option> <option value="3">3</option> <option value="4">4</option> <option value="5">5</option> <option value="6">6</option> <option value="7">7</option> <option value="8">8</option> </select> <button class="send-hint-btn" onclick="sendHint()">ÿ•ÿ±ÿ≥ÿßŸÑ</button>
      </div>
      <div class="current-hint" id="currentHintDisplay" style="display:none;">
       <div class="hint-text" id="hintText"></div>
       <div class="hint-count">
        ÿßŸÑŸÖÿ™ÿ®ŸÇŸä: <span id="remainingGuesses">0</span>
       </div>
      </div><button class="end-turn-btn" id="endTurnBtn" style="display:none;" onclick="endTurn()">‚è≠Ô∏è ÿ•ŸÜŸáÿßÿ° ÿßŸÑÿØŸàÿ±</button>
     </div>
    </div><!-- Blue Team Panel -->
    <div class="team-panel blue">
     <div class="team-header blue">
      <div>
       ÿßŸÑŸÅÿ±ŸäŸÇ ÿßŸÑÿ£ÿ≤ÿ±ŸÇ
      </div>
      <div class="team-score" id="blueScore">
       8
      </div>
     </div>
     <div class="team-section">
      <div class="section-title">
       üïµÔ∏è ÿßŸÑÿ¨ÿßÿ≥Ÿàÿ≥
      </div>
      <div id="blueSpyList"></div><button class="join-team-btn" onclick="joinTeam('blue', 'spy')">+ ÿ¨ÿßÿ≥Ÿàÿ≥</button>
     </div>
     <div class="team-section">
      <div class="section-title">
       üë• ÿßŸÑŸÑÿßÿπÿ®ŸàŸÜ
      </div>
      <div id="bluePlayersList"></div><button class="join-team-btn" onclick="joinTeam('blue', 'player')">+ ŸÑÿßÿπÿ®</button>
     </div>
    </div>
   </div>
  </div><!-- Players Modal -->
  <div class="modal-overlay" id="playersModal">
   <div class="modal">
    <div class="modal-title">
     üë• ÿßŸÑŸÑÿßÿπÿ®ŸàŸÜ ŸÅŸä ÿßŸÑÿ∫ÿ±ŸÅÿ©
    </div>
    <div class="modal-content">
     <div class="players-modal-list" id="playersModalList"></div>
    </div>
    <div class="modal-buttons"><button class="btn btn-secondary" onclick="closePlayersModal()">ÿ•ÿ∫ŸÑÿßŸÇ</button>
    </div>
   </div>
  </div><!-- Name Change Modal -->
  <div class="modal-overlay" id="nameModal">
   <div class="modal">
    <div class="modal-title">
     üë§ ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑÿßÿ≥ŸÖ
    </div>
    <div class="modal-content"><input type="text" class="input-field" id="newNameInput" placeholder="ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑÿ¨ÿØŸäÿØ" style="width:100%;">
    </div>
    <div class="modal-buttons"><button class="btn btn-secondary" onclick="closeNameModal()">ÿ•ŸÑÿ∫ÿßÿ°</button> <button class="btn btn-primary" onclick="changeName()">ÿ≠ŸÅÿ∏</button> <button class="btn btn-secondary" onclick="leaveRoom()" style="background:#ef4444;">ÿÆÿ±Ÿàÿ¨</button>
    </div>
   </div>
  </div><!-- Winner Overlay -->
  <div class="winner-overlay" id="winnerOverlay">
   <div class="winner-content">
    <div class="winner-emoji">
     üèÜ
    </div>
    <div class="winner-text" id="winnerText"></div>
    <div class="winner-reason" id="winnerReason"></div><button class="btn btn-primary" onclick="closeWinner()">ÿ≠ÿ≥ŸÜÿßŸã</button>
   </div>
  </div><!-- Toast -->
  <div class="toast" id="toast"></div>
  <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBLyoIoXp2aJCnhFqIFufMVBz0fzCS-FYY",
            authDomain: "game-303eb.firebaseapp.com",
            databaseURL: "https://game-303eb-default-rtdb.firebaseio.com",
            projectId: "game-303eb",
            storageBucket: "game-303eb.firebasestorage.app",
            messagingSenderId: "22261863844",
            appId: "1:22261863844:web:66f8541079b9025ec69d31"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // Arabic Words
        const arabicWords = [
            "ÿ¥ŸÖÿ≥", "ŸÇŸÖÿ±", "ŸÜÿ¨ŸÖ", "ÿ≥ŸÖÿßÿ°", "ÿ£ÿ±ÿ∂", "ÿ®ÿ≠ÿ±", "ÿ¨ÿ®ŸÑ", "ŸÜŸáÿ±", "ÿ¥ÿ¨ÿ±ÿ©", "Ÿàÿ±ÿØÿ©",
            "ŸÉÿ™ÿßÿ®", "ŸÇŸÑŸÖ", "Ÿàÿ±ŸÇÿ©", "ŸÖÿØÿ±ÿ≥ÿ©", "ŸÖÿπŸÑŸÖ", "ÿ∑ÿßŸÑÿ®", "ÿµŸÅ", "ÿØÿ±ÿ≥", "ÿßŸÖÿ™ÿ≠ÿßŸÜ", "ÿ¥ŸáÿßÿØÿ©",
            "ÿ®Ÿäÿ™", "ÿ®ÿßÿ®", "ŸÜÿßŸÅÿ∞ÿ©", "ÿ≥ŸÇŸÅ", "ÿ¨ÿØÿßÿ±", "ÿ∫ÿ±ŸÅÿ©", "ŸÖÿ∑ÿ®ÿÆ", "ÿ≠ŸÖÿßŸÖ", "ÿ≥ÿ±Ÿäÿ±", "ŸÉÿ±ÿ≥Ÿä",
            "ÿ≥Ÿäÿßÿ±ÿ©", "ÿ∑ÿßÿ¶ÿ±ÿ©", "ŸÇÿ∑ÿßÿ±", "ÿ≥ŸÅŸäŸÜÿ©", "ÿØÿ±ÿßÿ¨ÿ©", "ÿ∑ÿ±ŸäŸÇ", "ÿ¨ÿ≥ÿ±", "ŸÖÿ∑ÿßÿ±", "ŸÖÿ≠ÿ∑ÿ©", "ÿ¥ÿßÿ±ÿπ",
            "ÿ£ÿ≥ÿØ", "ŸÜŸÖÿ±", "ŸÅŸäŸÑ", "ÿ≤ÿ±ÿßŸÅÿ©", "ŸÇÿ±ÿØ", "ÿ∑ÿßÿ¶ÿ±", "ÿ≥ŸÖŸÉÿ©", "ŸÇÿ∑", "ŸÉŸÑÿ®", "ÿ≠ÿµÿßŸÜ",
            "ÿ™ŸÅÿßÿ≠ÿ©", "ŸÖŸàÿ≤ÿ©", "ÿ®ÿ±ÿ™ŸÇÿßŸÑ", "ÿπŸÜÿ®", "ŸÅÿ±ÿßŸàŸÑÿ©", "ÿ®ÿ∑ŸäÿÆ", "ÿ±ŸÖÿßŸÜ", "ÿ™ŸäŸÜ", "ÿ≤Ÿäÿ™ŸàŸÜ", "ŸÜÿÆŸÑÿ©",
            "ÿÆÿ®ÿ≤", "ÿ£ÿ±ÿ≤", "ŸÑÿ≠ŸÖ", "ÿØÿ¨ÿßÿ¨", "ÿ≥ŸÖŸÉ", "ÿ≠ŸÑŸäÿ®", "ÿ¨ÿ®ŸÜ", "ÿ®Ÿäÿ∂", "ÿ≤Ÿäÿ™", "ŸÖŸÑÿ≠",
            "ÿ∑ÿ®Ÿäÿ®", "ŸÖŸáŸÜÿØÿ≥", "ŸÖÿ≠ÿßŸÖŸä", "ÿ¥ÿ±ÿ∑Ÿä", "ÿ¨ŸÜÿØŸä", "ÿ∑Ÿäÿßÿ±", "ÿ®ÿ≠ÿßÿ±", "ŸÅŸÑÿßÿ≠", "ŸÜÿ¨ÿßÿ±", "ÿÆÿ®ÿßÿ≤",
            "ŸÉÿ±ÿ©", "ŸÖŸÑÿπÿ®", "ŸÅÿ±ŸäŸÇ", "ŸáÿØŸÅ", "ÿ≠ŸÉŸÖ", "ÿ®ÿ∑ŸàŸÑÿ©", "ŸÉÿ£ÿ≥", "ÿ∞Ÿáÿ®", "ŸÅÿ∂ÿ©", "ÿ®ÿ±ŸàŸÜÿ≤",
            "Ÿáÿßÿ™ŸÅ", "ÿ™ŸÑŸÅÿßÿ≤", "ÿ≠ÿßÿ≥Ÿàÿ®", "ÿ•ŸÜÿ™ÿ±ŸÜÿ™", "ŸÉÿßŸÖŸäÿ±ÿß", "ÿ≥ÿßÿπÿ©", "ŸÖŸÅÿ™ÿßÿ≠", "ŸÖÿ≠ŸÅÿ∏ÿ©", "ŸÜÿ∏ÿßÿ±ÿ©", "ŸÖÿ∏ŸÑÿ©",
            "ÿµŸäŸÅ", "ÿ¥ÿ™ÿßÿ°", "ÿ±ÿ®Ÿäÿπ", "ÿÆÿ±ŸäŸÅ", "ŸÖÿ∑ÿ±", "ÿ´ŸÑÿ¨", "ÿ±Ÿäÿßÿ≠", "ÿ∫ŸäŸàŸÖ", "ÿ®ÿ±ŸÇ", "ÿ±ÿπÿØ",
            "ÿ≠ÿ®", "ÿ≥ŸÑÿßŸÖ", "ÿ≠ÿ±ÿ®", "ÿµÿØÿßŸÇÿ©", "ÿπÿßÿ¶ŸÑÿ©", "ÿ£ŸÖ", "ÿ£ÿ®", "ÿ£ÿÆ", "ÿ£ÿÆÿ™", "ÿ¨ÿØ"
        ];

        // Game State
        let currentRoom = null;
        let currentPlayer = null;
        let playerId = null;
        let isCreator = false;
        let gameRef = null;
        let presenceRef = null;

        // Generate unique player ID
        function generateId() {
            return Math.random().toString(36).substr(2, 9);
        }

        // Generate room code
        function generateRoomCode() {
            return Math.random().toString(36).substr(2, 6).toUpperCase();
        }

        // Check URL for room code
        function checkUrlForRoom() {
            const urlParams = new URLSearchParams(window.location.search);
            const roomCode = urlParams.get('room');
            if (roomCode) {
                document.getElementById('roomCodeInput').value = roomCode;
            }
        }

        // Show toast message
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('active');
            setTimeout(() => toast.classList.remove('active'), 3000);
        }

        // Create new game
        document.getElementById('createGameBtn').addEventListener('click', async () => {
            const name = document.getElementById('playerName').value.trim();
            if (!name) {
                showToast('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿßÿ≥ŸÖŸÉ');
                return;
            }

            playerId = generateId();
            currentPlayer = { id: playerId, name: name, team: null, role: null, online: true };
            isCreator = true;

            const roomCode = generateRoomCode();
            currentRoom = roomCode;

            // Generate cards
            const shuffledWords = [...arabicWords].sort(() => Math.random() - 0.5).slice(0, 25);
            const startTeam = Math.random() < 0.5 ? 'red' : 'blue';
            const cardColors = generateCardColors(startTeam);

            const gameData = {
                roomCode: roomCode,
                creator: playerId,
                createdAt: Date.now(),
                status: 'waiting',
                currentTurn: startTeam,
                phase: 'hint', // hint or guess
                cards: shuffledWords.map((word, i) => ({
                    word: word,
                    color: cardColors[i],
                    revealed: false,
                    votes: {}
                })),
                hint: null,
                hintCount: 0,
                remainingGuesses: 0,
                redScore: startTeam === 'red' ? 9 : 8,
                blueScore: startTeam === 'blue' ? 9 : 8,
                players: {
                    [playerId]: currentPlayer
                },
                activity: [],
                winner: null
            };

            await db.ref('rooms/' + roomCode).set(gameData);
            
            setupPresence(roomCode);
            startGame(roomCode);
        });

        // Join existing game
        document.getElementById('joinGameBtn').addEventListener('click', async () => {
            const name = document.getElementById('playerName').value.trim();
            const roomCode = document.getElementById('roomCodeInput').value.trim().toUpperCase();

            if (!name) {
                showToast('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿßÿ≥ŸÖŸÉ');
                return;
            }
            if (!roomCode) {
                showToast('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ŸÉŸàÿØ ÿßŸÑÿ∫ÿ±ŸÅÿ©');
                return;
            }

            const snapshot = await db.ref('rooms/' + roomCode).once('value');
            if (!snapshot.exists()) {
                showToast('ÿßŸÑÿ∫ÿ±ŸÅÿ© ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØÿ©');
                return;
            }

            playerId = generateId();
            currentPlayer = { id: playerId, name: name, team: null, role: null, online: true };
            currentRoom = roomCode;

            const gameData = snapshot.val();
            isCreator = gameData.creator === playerId;

            await db.ref('rooms/' + roomCode + '/players/' + playerId).set(currentPlayer);
            
            setupPresence(roomCode);
            startGame(roomCode);
        });

        // Generate card colors
        function generateCardColors(startTeam) {
            const colors = [];
            const firstTeamCount = 9;
            const secondTeamCount = 8;

            // Add colors based on start team
            for (let i = 0; i < firstTeamCount; i++) colors.push(startTeam);
            for (let i = 0; i < secondTeamCount; i++) colors.push(startTeam === 'red' ? 'blue' : 'red');
            colors.push('black');
            for (let i = 0; i < 7; i++) colors.push('neutral');

            // Shuffle
            return colors.sort(() => Math.random() - 0.5);
        }

        // Setup presence system
        function setupPresence(roomCode) {
            presenceRef = db.ref('rooms/' + roomCode + '/players/' + playerId);
            
            presenceRef.onDisconnect().update({ online: false });
            
            // Keep alive
            setInterval(() => {
                if (presenceRef) {
                    presenceRef.update({ online: true, lastSeen: Date.now() });
                }
            }, 5000);
        }

        // Start game and listen for updates
        function startGame(roomCode) {
            document.getElementById('mainScreen').style.display = 'none';
            document.getElementById('gameScreen').style.display = 'flex';

            gameRef = db.ref('rooms/' + roomCode);
            
            gameRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    updateGameUI(data);
                }
            });

            // Update URL
            const baseUrl = 'https://mayadinq8.github.io/marabit/';
            window.history.replaceState({}, '', '?room=' + roomCode);

            document.getElementById('currentPlayerName').textContent = currentPlayer.name;

            // Show reset button for creator
            if (isCreator) {
                document.getElementById('resetGameBtn').style.display = 'block';
            }
        }

        // Update game UI
        function updateGameUI(data) {
            // Update players count
            const players = data.players || {};
            const playerCount = Object.keys(players).length;
            document.getElementById('playersCount').querySelector('span').textContent = playerCount;

            // Update current player data
            if (players[playerId]) {
                currentPlayer = players[playerId];
            }

            // Check if player was kicked
            if (!players[playerId] && currentRoom) {
                showToast('ÿ™ŸÖ ÿ∑ÿ±ÿØŸÉ ŸÖŸÜ ÿßŸÑÿ∫ÿ±ŸÅÿ©');
                leaveRoom();
                return;
            }

            // Update scores
            document.getElementById('redScore').textContent = data.redScore;
            document.getElementById('blueScore').textContent = data.blueScore;

            // Update turn indicator
            updateTurnIndicator(data);

            // Update team lists
            updateTeamLists(players);

            // Update cards
            updateCards(data);

            // Update hint section
            updateHintSection(data);

            // Update activity log
            updateActivityLog(data.activity || []);

            // Check for winner
            if (data.winner && !document.getElementById('winnerOverlay').classList.contains('shown')) {
                showWinner(data.winner, data.winReason);
            }

            // Update creator status
            isCreator = data.creator === playerId;
            document.getElementById('resetGameBtn').style.display = isCreator ? 'block' : 'none';
        }

        // Update turn indicator
        function updateTurnIndicator(data) {
            const indicator = document.getElementById('turnIndicator');
            
            if (data.winner) {
                indicator.textContent = data.winner === 'red' ? 'üèÜ ŸÅÿßÿ≤ ÿßŸÑŸÅÿ±ŸäŸÇ ÿßŸÑÿ£ÿ≠ŸÖÿ±!' : 'üèÜ ŸÅÿßÿ≤ ÿßŸÑŸÅÿ±ŸäŸÇ ÿßŸÑÿ£ÿ≤ÿ±ŸÇ!';
                indicator.className = 'turn-indicator turn-' + data.winner;
                return;
            }

            if (data.status === 'waiting') {
                indicator.textContent = 'ŸÅŸä ÿßŸÜÿ™ÿ∏ÿßÿ± ÿßŸÑŸÑÿßÿπÿ®ŸäŸÜ...';
                indicator.className = 'turn-indicator';
                return;
            }

            const teamName = data.currentTurn === 'red' ? 'ÿßŸÑŸÅÿ±ŸäŸÇ ÿßŸÑÿ£ÿ≠ŸÖÿ±' : 'ÿßŸÑŸÅÿ±ŸäŸÇ ÿßŸÑÿ£ÿ≤ÿ±ŸÇ';
            const phaseText = data.phase === 'hint' ? 'üïµÔ∏è ÿØŸàÿ± ÿßŸÑÿ¨ÿßÿ≥Ÿàÿ≥' : 'üëÜ ÿØŸàÿ± ÿßŸÑÿ™ÿÆŸÖŸäŸÜ';
            indicator.textContent = `${teamName} - ${phaseText}`;
            indicator.className = 'turn-indicator turn-' + data.currentTurn;
        }

        // Update team lists
        function updateTeamLists(players) {
            const redSpyList = document.getElementById('redSpyList');
            const redPlayersList = document.getElementById('redPlayersList');
            const blueSpyList = document.getElementById('blueSpyList');
            const bluePlayersList = document.getElementById('bluePlayersList');

            redSpyList.innerHTML = '';
            redPlayersList.innerHTML = '';
            blueSpyList.innerHTML = '';
            bluePlayersList.innerHTML = '';

            Object.values(players).forEach(player => {
                if (!player.team) return;

                const div = document.createElement('div');
                div.className = `player-item ${player.team} ${player.online ? '' : 'offline'}`;
                div.innerHTML = `
                    <span>${player.name}</span>
                    ${!player.online ? '<span style="font-size:0.6rem;">üì¥</span>' : ''}
                `;

                if (player.team === 'red') {
                    if (player.role === 'spy') redSpyList.appendChild(div);
                    else redPlayersList.appendChild(div);
                } else {
                    if (player.role === 'spy') blueSpyList.appendChild(div);
                    else bluePlayersList.appendChild(div);
                }
            });
        }

        // Update cards
        function updateCards(data) {
            const grid = document.getElementById('cardsGrid');
            const isSpy = currentPlayer.role === 'spy';
            const canVote = currentPlayer.role === 'player' && 
                           currentPlayer.team === data.currentTurn && 
                           data.phase === 'guess' &&
                           !data.winner;

            grid.innerHTML = '';

            data.cards.forEach((card, index) => {
                const div = document.createElement('div');
                let classes = 'card';

                if (card.revealed) {
                    classes += ` revealed ${card.color}`;
                } else if (isSpy) {
                    classes += ` spy-${card.color}`;
                }

                if (canVote && !card.revealed) {
                    classes += ' can-vote';
                }

                div.className = classes;

                // Voters display
                const votes = card.votes || {};
                const voterNames = Object.values(votes).map(v => 
                    `<span class="voter-name ${v.team}">${v.name}</span>`
                ).join('');

                div.innerHTML = `
                    <button class="hand-btn" onclick="confirmVote(${index}, event)">‚úã</button>
                    <span class="card-word">${card.word}</span>
                    <div class="voters-display">${voterNames}</div>
                `;

                div.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('hand-btn')) {
                        toggleVote(index, data);
                    }
                });

                grid.appendChild(div);
            });
        }

        // Toggle vote on card
        async function toggleVote(index, data) {
            if (currentPlayer.role !== 'player' || !currentPlayer.team) return;
            if (data.currentTurn !== currentPlayer.team) return;
            if (data.phase !== 'guess') return;
            if (data.cards[index].revealed) return;
            if (data.winner) return;

            const voteRef = db.ref(`rooms/${currentRoom}/cards/${index}/votes/${playerId}`);
            const snapshot = await voteRef.once('value');

            if (snapshot.exists()) {
                await voteRef.remove();
            } else {
                await voteRef.set({
                    name: currentPlayer.name,
                    team: currentPlayer.team
                });
            }
        }

        // Confirm vote and reveal card
        async function confirmVote(index, event) {
            event.stopPropagation();

            const snapshot = await db.ref(`rooms/${currentRoom}`).once('value');
            const data = snapshot.val();

            if (currentPlayer.role !== 'player' || !currentPlayer.team) return;
            if (data.currentTurn !== currentPlayer.team) return;
            if (data.phase !== 'guess') return;
            if (data.cards[index].revealed) return;
            if (data.winner) return;

            const card = data.cards[index];
            const updates = {};

            // Reveal card
            updates[`cards/${index}/revealed`] = true;
            updates[`cards/${index}/votes`] = {};

            // Add activity
            const activity = data.activity || [];
            activity.push({
                type: 'guess',
                team: currentPlayer.team,
                player: currentPlayer.name,
                word: card.word,
                result: card.color,
                time: Date.now()
            });
            updates['activity'] = activity;

            let newRemaining = data.remainingGuesses - 1;

            // Check card color
            if (card.color === 'black') {
                // Game over - other team wins
                const winner = currentPlayer.team === 'red' ? 'blue' : 'red';
                updates['winner'] = winner;
                updates['winReason'] = 'black';
                activity.push({
                    type: 'winner',
                    team: winner,
                    reason: 'ÿßŸÑŸÅÿ±ŸäŸÇ ÿßŸÑÿÆÿµŸÖ ÿ∂ÿ∫ÿ∑ ÿπŸÑŸâ ÿßŸÑÿ®ÿ∑ÿßŸÇÿ© ÿßŸÑÿ≥ŸàÿØÿßÿ°',
                    time: Date.now()
                });
            } else if (card.color === currentPlayer.team) {
                // Correct guess
                const scoreKey = currentPlayer.team + 'Score';
                const newScore = data[scoreKey] - 1;
                updates[scoreKey] = newScore;

                if (newScore === 0) {
                    // Team wins
                    updates['winner'] = currentPlayer.team;
                    updates['winReason'] = 'complete';
                    activity.push({
                        type: 'winner',
                        team: currentPlayer.team,
                        reason: 'ÿ£ŸÉŸÖŸÑ ÿ¨ŸÖŸäÿπ ŸÉŸÑŸÖÿßÿ™Ÿá',
                        time: Date.now()
                    });
                } else if (newRemaining <= 0) {
                    // End turn
                    updates['currentTurn'] = currentPlayer.team === 'red' ? 'blue' : 'red';
                    updates['phase'] = 'hint';
                    updates['hint'] = null;
                    updates['hintCount'] = 0;
                    updates['remainingGuesses'] = 0;
                } else {
                    updates['remainingGuesses'] = newRemaining;
                }
            } else if (card.color === 'neutral') {
                // Neutral - end turn
                updates['currentTurn'] = currentPlayer.team === 'red' ? 'blue' : 'red';
                updates['phase'] = 'hint';
                updates['hint'] = null;
                updates['hintCount'] = 0;
                updates['remainingGuesses'] = 0;
            } else {
                // Enemy card - give them point and end turn
                const enemyTeam = currentPlayer.team === 'red' ? 'blue' : 'red';
                const enemyScoreKey = enemyTeam + 'Score';
                const newEnemyScore = data[enemyScoreKey] - 1;
                updates[enemyScoreKey] = newEnemyScore;

                if (newEnemyScore === 0) {
                    updates['winner'] = enemyTeam;
                    updates['winReason'] = 'complete';
                    activity.push({
                        type: 'winner',
                        team: enemyTeam,
                        reason: 'ÿ£ŸÉŸÖŸÑ ÿ¨ŸÖŸäÿπ ŸÉŸÑŸÖÿßÿ™Ÿá ÿ®ŸÖÿ≥ÿßÿπÿØÿ© ÿßŸÑÿÆÿµŸÖ',
                        time: Date.now()
                    });
                } else {
                    updates['currentTurn'] = enemyTeam;
                    updates['phase'] = 'hint';
                    updates['hint'] = null;
                    updates['hintCount'] = 0;
                    updates['remainingGuesses'] = 0;
                }
            }

            updates['activity'] = activity;
            await db.ref(`rooms/${currentRoom}`).update(updates);
        }

        // Update hint section
        function updateHintSection(data) {
            const hintSection = document.getElementById('hintSection');
            const hintInputRow = document.getElementById('hintInputRow');
            const currentHintDisplay = document.getElementById('currentHintDisplay');
            const endTurnBtn = document.getElementById('endTurnBtn');

            if (data.winner || data.status === 'waiting') {
                hintSection.style.display = 'none';
                return;
            }

            hintSection.style.display = 'block';

            // Check if current player is spy of current team
            const isCurrentSpy = currentPlayer.role === 'spy' && 
                                currentPlayer.team === data.currentTurn &&
                                data.phase === 'hint';

            const isCurrentPlayer = currentPlayer.role === 'player' && 
                                   currentPlayer.team === data.currentTurn &&
                                   data.phase === 'guess';

            hintInputRow.style.display = isCurrentSpy ? 'flex' : 'none';

            if (data.hint) {
                currentHintDisplay.style.display = 'block';
                document.getElementById('hintText').textContent = data.hint;
                document.getElementById('remainingGuesses').textContent = data.remainingGuesses;
            } else {
                currentHintDisplay.style.display = 'none';
            }

            endTurnBtn.style.display = isCurrentPlayer ? 'block' : 'none';
        }

        // Send hint
        async function sendHint() {
            const hintInput = document.getElementById('hintInput');
            const hintCount = document.getElementById('hintCountSelect').value;
            const hint = hintInput.value.trim();

            if (!hint) {
                showToast('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿßŸÑÿ™ŸÑŸÖŸäÿ≠');
                return;
            }

            const snapshot = await db.ref(`rooms/${currentRoom}`).once('value');
            const data = snapshot.val();

            const activity = data.activity || [];
            activity.push({
                type: 'hint',
                team: currentPlayer.team,
                player: currentPlayer.name,
                hint: hint,
                count: hintCount,
                time: Date.now()
            });

            await db.ref(`rooms/${currentRoom}`).update({
                hint: hint,
                hintCount: parseInt(hintCount),
                remainingGuesses: parseInt(hintCount) + 1,
                phase: 'guess',
                status: 'playing',
                activity: activity
            });

            hintInput.value = '';
        }

        // End turn
        async function endTurn() {
            const snapshot = await db.ref(`rooms/${currentRoom}`).once('value');
            const data = snapshot.val();

            if (data.currentTurn !== currentPlayer.team) return;
            if (data.phase !== 'guess') return;

            const nextTeam = currentPlayer.team === 'red' ? 'blue' : 'red';

            await db.ref(`rooms/${currentRoom}`).update({
                currentTurn: nextTeam,
                phase: 'hint',
                hint: null,
                hintCount: 0,
                remainingGuesses: 0
            });
        }

        // Update activity log
        function updateActivityLog(activity) {
            const list = document.getElementById('activityList');
            list.innerHTML = '';

            [...activity].reverse().slice(0, 20).forEach(item => {
                const div = document.createElement('div');
                
                if (item.type === 'winner') {
                    div.className = 'activity-item winner';
                    div.textContent = `üèÜ ${item.team === 'red' ? 'ÿßŸÑÿ£ÿ≠ŸÖÿ±' : 'ÿßŸÑÿ£ÿ≤ÿ±ŸÇ'} ŸÅÿßÿ≤! - ${item.reason}`;
                } else if (item.type === 'hint') {
                    div.className = 'activity-item ' + item.team;
                    div.textContent = `üïµÔ∏è ${item.player}: "${item.hint}" (${item.count})`;
                } else if (item.type === 'guess') {
                    div.className = 'activity-item ' + item.team;
                    const resultEmoji = item.result === item.team ? '‚úÖ' : (item.result === 'black' ? 'üíÄ' : '‚ùå');
                    div.textContent = `${resultEmoji} ${item.player} ÿßÿÆÿ™ÿßÿ± "${item.word}"`;
                }

                list.appendChild(div);
            });
        }

        // Join team
        async function joinTeam(team, role) {
            if (currentPlayer.team && currentPlayer.team !== team) {
                // Leave current team first
            }

            await db.ref(`rooms/${currentRoom}/players/${playerId}`).update({
                team: team,
                role: role
            });

            currentPlayer.team = team;
            currentPlayer.role = role;
        }

        // Show players modal
        async function showPlayersModal() {
            const snapshot = await db.ref(`rooms/${currentRoom}`).once('value');
            const data = snapshot.val();
            const players = data.players || {};

            const list = document.getElementById('playersModalList');
            list.innerHTML = '';

            Object.entries(players).forEach(([id, player]) => {
                const div = document.createElement('div');
                div.className = `player-modal-item ${player.online ? '' : 'offline'}`;
                
                let teamText = 'ÿ®ÿØŸàŸÜ ŸÅÿ±ŸäŸÇ';
                if (player.team) {
                    teamText = player.team === 'red' ? 'ÿ£ÿ≠ŸÖÿ±' : 'ÿ£ÿ≤ÿ±ŸÇ';
                    teamText += player.role === 'spy' ? ' (ÿ¨ÿßÿ≥Ÿàÿ≥)' : ' (ŸÑÿßÿπÿ®)';
                }

                div.innerHTML = `
                    <div>
                        <strong>${player.name}</strong>
                        <small style="display:block;color:#888;">${teamText}</small>
                    </div>
                    ${isCreator && id !== playerId ? `<button class="kick-btn" onclick="kickPlayer('${id}')">ÿ∑ÿ±ÿØ</button>` : ''}
                `;

                list.appendChild(div);
            });

            document.getElementById('playersModal').classList.add('active');
        }

        function closePlayersModal() {
            document.getElementById('playersModal').classList.remove('active');
        }

        // Kick player
        async function kickPlayer(id) {
            if (!isCreator) return;
            await db.ref(`rooms/${currentRoom}/players/${id}`).remove();
            showToast('ÿ™ŸÖ ÿ∑ÿ±ÿØ ÿßŸÑŸÑÿßÿπÿ®');
        }

        // Name modal
        document.getElementById('playerNameBtn').addEventListener('click', () => {
            document.getElementById('newNameInput').value = currentPlayer.name;
            document.getElementById('nameModal').classList.add('active');
        });

        function closeNameModal() {
            document.getElementById('nameModal').classList.remove('active');
        }

        async function changeName() {
            const newName = document.getElementById('newNameInput').value.trim();
            if (!newName) {
                showToast('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿßÿ≥ŸÖ');
                return;
            }

            await db.ref(`rooms/${currentRoom}/players/${playerId}`).update({ name: newName });
            currentPlayer.name = newName;
            document.getElementById('currentPlayerName').textContent = newName;
            closeNameModal();
            showToast('ÿ™ŸÖ ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑÿßÿ≥ŸÖ');
        }

        // Leave room
        function leaveRoom() {
            if (gameRef) {
                gameRef.off();
            }
            if (presenceRef) {
                presenceRef.remove();
            }
            currentRoom = null;
            currentPlayer = null;
            document.getElementById('gameScreen').style.display = 'none';
            document.getElementById('mainScreen').style.display = 'flex';
            closeNameModal();
            window.history.replaceState({}, '', window.location.pathname);
        }

        // Copy room link
        function copyRoomLink() {
            const link = `https://mayadinq8.github.io/marabit/?room=${currentRoom}`;
            navigator.clipboard.writeText(link).then(() => {
                showToast('ÿ™ŸÖ ŸÜÿ≥ÿÆ ÿßŸÑÿ±ÿßÿ®ÿ∑');
            }).catch(() => {
                showToast('ŸÅÿ¥ŸÑ ŸÜÿ≥ÿÆ ÿßŸÑÿ±ÿßÿ®ÿ∑');
            });
        }

        // Reset game
        document.getElementById('resetGameBtn').addEventListener('click', async () => {
            if (!isCreator) return;

            const snapshot = await db.ref(`rooms/${currentRoom}`).once('value');
            const data = snapshot.val();

            const shuffledWords = [...arabicWords].sort(() => Math.random() - 0.5).slice(0, 25);
            const startTeam = Math.random() < 0.5 ? 'red' : 'blue';
            const cardColors = generateCardColors(startTeam);

            await db.ref(`rooms/${currentRoom}`).update({
                currentTurn: startTeam,
                phase: 'hint',
                cards: shuffledWords.map((word, i) => ({
                    word: word,
                    color: cardColors[i],
                    revealed: false,
                    votes: {}
                })),
                hint: null,
                hintCount: 0,
                remainingGuesses: 0,
                redScore: startTeam === 'red' ? 9 : 8,
                blueScore: startTeam === 'blue' ? 9 : 8,
                activity: [],
                winner: null,
                winReason: null,
                status: 'waiting'
            });

            document.getElementById('winnerOverlay').classList.remove('active', 'shown');
            showToast('ÿ™ŸÖ ÿ•ÿπÿßÿØÿ© ÿßŸÑŸÑÿπÿ®ÿ©');
        });

        // Show winner
        function showWinner(winner, reason) {
            const overlay = document.getElementById('winnerOverlay');
            const text = document.getElementById('winnerText');
            const reasonEl = document.getElementById('winnerReason');

            text.textContent = winner === 'red' ? 'ŸÅÿßÿ≤ ÿßŸÑŸÅÿ±ŸäŸÇ ÿßŸÑÿ£ÿ≠ŸÖÿ±!' : 'ŸÅÿßÿ≤ ÿßŸÑŸÅÿ±ŸäŸÇ ÿßŸÑÿ£ÿ≤ÿ±ŸÇ!';
            text.className = 'winner-text ' + winner;

            if (reason === 'black') {
                reasonEl.textContent = 'ÿßŸÑŸÅÿ±ŸäŸÇ ÿßŸÑÿÆÿµŸÖ ÿ∂ÿ∫ÿ∑ ÿπŸÑŸâ ÿßŸÑÿ®ÿ∑ÿßŸÇÿ© ÿßŸÑÿ≥ŸàÿØÿßÿ°';
            } else {
                reasonEl.textContent = 'ÿ£ŸÉŸÖŸÑ ÿ¨ŸÖŸäÿπ ŸÉŸÑŸÖÿßÿ™Ÿá ÿ®ŸÜÿ¨ÿßÿ≠';
            }

            overlay.classList.add('active', 'shown');
        }

        function closeWinner() {
            document.getElementById('winnerOverlay').classList.remove('active');
        }

        // Initialize
        checkUrlForRoom();
        
        // Initialize Element SDK
        if (window.elementSdk) {
            window.elementSdk.init({
                defaultConfig: {},
                onConfigChange: async () => {},
                mapToCapabilities: () => ({
                    recolorables: [],
                    borderables: [],
                    fontEditable: undefined,
                    fontSizeable: undefined
                }),
                mapToEditPanelValues: () => new Map()
            });
        }
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9c0fcc9f75ce51c2',t:'MTc2ODkyNDk3OS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
